<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Focus on Mysql,Focus on DB,Focus on Focus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="特殊场景下的slave重构

It is important to back up your databases so that you can recover your data and be up and running again in case problems occur, such as system crashes, hardware failures, or users delet">
<meta property="og:type" content="article">
<meta property="og:title" content="Focus on Mysql,Focus on DB,Focus on Focus">
<meta property="og:url" content="https://github.com/Keithlan/Keithlan.github.io/2015/07/14/mysql_recovery_myisam_slave/">
<meta property="og:site_name" content="Focus on Mysql,Focus on DB,Focus on Focus">
<meta property="og:description" content="特殊场景下的slave重构

It is important to back up your databases so that you can recover your data and be up and running again in case problems occur, such as system crashes, hardware failures, or users delet">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Focus on Mysql,Focus on DB,Focus on Focus">
<meta name="twitter:description" content="特殊场景下的slave重构

It is important to back up your databases so that you can recover your data and be up and running again in case problems occur, such as system crashes, hardware failures, or users delet">

  
    <link rel="alternative" href="/atom.xml" title="Focus on Mysql,Focus on DB,Focus on Focus" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Focus on Mysql,Focus on DB,Focus on Focus</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:https://github.com/Keithlan/Keithlan.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-mysql_recovery_myisam_slave" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/14/mysql_recovery_myisam_slave/" class="article-date">
  <time datetime="2015-07-14T11:30:10.000Z" itemprop="datePublished">Jul 14 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="特殊场景下的slave重构">特殊场景下的slave重构</h1>
<blockquote>
<p>It is important to back up your databases so that you can recover your data and be up and running again in case problems occur, such as system crashes, hardware failures, or users deleting data by mistake. Backups are also essential as a safeguard before upgrading a MySQL installation, and they can be used to transfer a MySQL installation to another system or to set up replication slave servers.</p>
</blockquote>
<p><a href="http://dev.mysql.com/doc/refman/5.6/en/backup-and-recovery.html" target="_blank" rel="external">Mysql Backup and Recovery</a></p>
<h2 id="背景说明">背景说明</h2>
<hr>
<p>备份和恢复，这是一个非常大的话题，但这不是本章的重点，关于详情，请看之前分享过的一篇PDF <a href="https://github.com/Keithlan/Keithlan.github.io/tree/master/github_md/Mysql/BACKUP_RECOVERY" target="_blank" rel="external">Mysql Backup and Recovery 分享</a> 。 备份，主要是用于灾难恢复。 那么，今天我们就来讨论一下再没有备份的前提下，如果从master上恢复一台slave出来？</p>
<h2 id="前提">前提</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">* Master</div><div class="line">	1. Myisam 引擎</div><div class="line">	2. 无全量备份</div><div class="line">	3. 有最近2天的binlog</div><div class="line">	4. SQL语句特点： 全是insert</div><div class="line">	5. 每个表都有主键id，并且auto increment </div><div class="line">* Master 上的table</div><div class="line">	1. table1_YYYMM (按月分表)</div><div class="line">	2. table2_YYYMMDD (按天分表)</div><div class="line">	3. table3 (整张表)</div></pre></td></tr></table></figure>

<p>如果是innoDB 引擎，到时可以用mysqldump —single transaction 或者 percona xtrabackup 来恢复。  但是在Myisam中，在这种场景下，如何恢复搭建slave呢？</p>
<h2 id="方案一">方案一</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1. copy 已经不在写的表，比如table1_YYYMM 今天之前，今月之前的表。 消耗时间A</div><div class="line">2. 在master 上<span class="operator"><span class="keyword">flush</span> <span class="keyword">tables</span> <span class="keyword">with</span> <span class="keyword">read</span> <span class="keyword">lock</span>；<span class="keyword">show</span> <span class="keyword">master</span> <span class="keyword">status</span>；消耗时间B</span></div><div class="line"><span class="number">3.</span> copy 剩下的表； 消耗时间C</div><div class="line"><span class="number">4.</span> <span class="keyword">unlock</span> <span class="keyword">tables</span>；</div><div class="line"><span class="number">5.</span> 在<span class="keyword">slave</span>上，开启同步</div></pre></td></tr></table></figure>

<ul>
<li><strong>方案一的优点和缺点也很明显：</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">*</span>优点</div><div class="line">	1.无须担心一致性问题。</div><div class="line"><span class="keyword">*</span>缺点</div><div class="line">	1. 需要锁表，锁住的时间就是copy数据的时间C。 表越大，锁越长，有些业务是不允许这么长时间的。</div></pre></td></tr></table></figure>

<h2 id="方案二">方案二</h2>
<p>这里主要抓住一点，只有insert操作。根据这个特性，我们可以针对性的恢复</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">* 检查一下表的自增主键</div><div class="line">* 第一步：提前先copy好所有不再写的表，比如table1_YYYMM 今天之前，今月之前的表，同上。  消耗时间A</div><div class="line">* 第二步：然后再copy 当天，当月，当时的表， 并且记下 max（主键），一遍后续补数据用。  消耗时间B</div><div class="line">* 第三步：在master上  消耗时间C</div><div class="line"> 	1. <span class="operator"><span class="keyword">flush</span> <span class="keyword">tables</span> <span class="keyword">with</span> <span class="keyword">read</span> <span class="keyword">lock</span>；</span></div><div class="line"> 	<span class="number">2.</span> <span class="keyword">show</span> <span class="keyword">master</span> <span class="keyword">status</span>； </div><div class="line"> 	<span class="number">3.</span> 记下当天，当月，当时的表的<span class="keyword">max</span>（主键），由于是myisam引擎，基本是瞬间完成。 </div><div class="line"> 	<span class="number">4.</span> <span class="keyword">unlock</span> <span class="keyword">tables</span>； </div><div class="line">* 第四步：修补第二步和第三步 <span class="keyword">max</span>（主键）中的空洞。  </div><div class="line">* 第五步：<span class="keyword">repair</span> 部分表，可以用同步机制自动检测且修复，无须人为关心。</div><div class="line">* 第六步：在<span class="keyword">slave</span>上，开启同步</div></pre></td></tr></table></figure>

<ul>
<li><strong>方案二的优点和缺点：</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">* 优点：</div><div class="line">	1. 基本上无中断业务时间。</div><div class="line">	2. 不会丢失任何数据。</div><div class="line">* 缺点：</div><div class="line">	1. 需要脚本处理max值，记录position点。</div><div class="line">	2. 需要repair表。</div><div class="line">	3. 如果有update，delete语句，有风险。</div></pre></td></tr></table></figure>

<p>以上，就是这次奇葩的数据恢复。</p>
<h2 id="总结">总结</h2>
<ol>
<li>没有备份，等于自掘坟墓。</li>
<li>没有测试恢复过的备份，等于没有备份。</li>
<li>请看第一点。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/Keithlan/Keithlan.github.io/2015/07/14/mysql_recovery_myisam_slave/" data-id="8a34hqvrmjw5wrsw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/07/14/mysql_replicate_rule/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2015/07/14/mysql_in/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>




<section id="comments">
  <!-- Duoshuo Comment BEGIN -->
  <div class="ds-thread"></div>
    <script type="text/javascript">
      var duoshuoQuery = {short_name:"兰春"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
  </script>
<!-- Duoshuo Comment END -->
</section>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL-Error/">MySQL Error</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/MySQL-Error/" style="font-size: NaNpx;">MySQL Error</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/07/14/mysql_group_order_limit/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/07/14/mysql_shutdown_err/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/07/14/mysql_ulimit/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/07/14/mysql_replicate_rule/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/07/14/mysql_recovery_myisam_slave/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<script src="/js/script.js" type="text/javascript"></script>


  </div>
</body>
</html>