<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Focus on Mysql,Focus on DB,Focus on Focus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Mysql 5.6 执行计划错误案例分析

Depending on the details of your tables, columns, indexes, and the conditions inyour WHERE clause, the MySQL optimizer considers many techniques to efficientlyperform the lookups">
<meta property="og:type" content="article">
<meta property="og:title" content="Focus on Mysql,Focus on DB,Focus on Focus">
<meta property="og:url" content="https://github.com/Keithlan/Keithlan.github.io/2015/07/14/mysql_group_order_limit/">
<meta property="og:site_name" content="Focus on Mysql,Focus on DB,Focus on Focus">
<meta property="og:description" content="Mysql 5.6 执行计划错误案例分析

Depending on the details of your tables, columns, indexes, and the conditions inyour WHERE clause, the MySQL optimizer considers many techniques to efficientlyperform the lookups">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Focus on Mysql,Focus on DB,Focus on Focus">
<meta name="twitter:description" content="Mysql 5.6 执行计划错误案例分析

Depending on the details of your tables, columns, indexes, and the conditions inyour WHERE clause, the MySQL optimizer considers many techniques to efficientlyperform the lookups">

  
    <link rel="alternative" href="/atom.xml" title="Focus on Mysql,Focus on DB,Focus on Focus" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Focus on Mysql,Focus on DB,Focus on Focus</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:https://github.com/Keithlan/Keithlan.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-mysql_group_order_limit" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/14/mysql_group_order_limit/" class="article-date">
  <time datetime="2015-07-14T11:30:10.000Z" itemprop="datePublished">Jul 14 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Mysql_5-6_执行计划错误案例分析">Mysql 5.6 执行计划错误案例分析</h1>
<blockquote>
<p>Depending on the details of your tables, columns, indexes, and the conditions in<br>your WHERE clause, the MySQL optimizer considers many techniques to efficiently<br>perform the lookups involved in an SQL query. A query on a huge table can be<br>performed without reading all the rows; a join involving several tables can be performed without comparing every combination of rows. The set of operations that the optimizer chooses to perform the most efficient query is called the “query execution plan”, also known as the EXPLAIN plan. Your goals are to recognize the aspects of the EXPLAIN plan that indicate a query is optimized well, and to learn the SQL syntax and indexing techniques to improve the plan if you see some inefficient operations.</p>
</blockquote>
<p><a href="http://dev.mysql.com/doc/refman/5.5/en/execution-plan-information.html" target="_blank" rel="external">Understanding the Query Execution Plan</a></p>
<h2 id="前提">前提</h2>
<hr>
<p>Mysql 优化器本就是为了优化SQL语句的查找路径而存在，当优化器足够智能的时候，这是一件美事。但是，如果优化器犯二的时候呢？有的时候执行计划看上去非常好，但是慢的无可救药。有的时候执行计划看上去很差，却跑的很欢。  接下来我们一起来看一下下面的例子：</p>
<ul>
<li><strong>表结构</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`prop_promotion_data`</span> (</span></div><div class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`brokerid`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'经纪人id'</span>,</div><div class="line">  <span class="string">`groupid`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'组id'</span>,</div><div class="line">  <span class="string">`cid`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'总帐号id'</span>,</div><div class="line">  <span class="string">`gid`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'组帐号id'</span>,</div><div class="line">  <span class="string">`fix_prop_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'定价推广房源总数'</span>,</div><div class="line">  <span class="string">`more_10hours_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'定价推广超过10小时房源数'</span>,</div><div class="line">  <span class="string">`new_add_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'每天新增定价推广房源数'</span>,</div><div class="line">  <span class="string">`multi_map_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'多图房源数'</span>,</div><div class="line">  <span class="string">`fix_clicks`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'定价推广房源点击量'</span>,</div><div class="line">  <span class="string">`fix_consume`</span> <span class="built_in">float</span>(<span class="number">8</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'定价推广花费'</span>,</div><div class="line">  <span class="string">`bid_prop_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'竞价推广房源数'</span>,</div><div class="line">  <span class="string">`bid_clicks`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'竞价点击量'</span>,</div><div class="line">  <span class="string">`bid_consume`</span> <span class="built_in">float</span>(<span class="number">8</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'竞价推广花费'</span>,</div><div class="line">  <span class="string">`report_date`</span> <span class="built_in">int</span>(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'统计日期'</span>,</div><div class="line">  <span class="string">`last_update`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'最后更新时间'</span>,</div><div class="line">  <span class="string">`cst_broker_company_ids`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'关联anjuke_db.ajk_brokerextend中的cst_broker_company_id'</span>,</div><div class="line">  <span class="string">`new_fix_multi_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'新增定价多图房源'</span>,</div><div class="line">  <span class="string">`new_bid_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'新增竞价房源数'</span>,</div><div class="line">  <span class="string">`bid_multi_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'竞价多图房源'</span>,</div><div class="line">  <span class="string">`new_bid_multi_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'新增竞价多图房源'</span>,</div><div class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="string">`id`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`cid`</span> (<span class="string">`cid`</span>,<span class="string">`report_date`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`gid`</span> (<span class="string">`gid`</span>,<span class="string">`report_date`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`report_date`</span> (<span class="string">`report_date`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`brokerid`</span> (<span class="string">`brokerid`</span>,<span class="string">`report_date`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`cst_date`</span> (<span class="string">`cst_broker_company_ids`</span>,<span class="string">`report_date`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">57230309</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 COMMENT=<span class="string">'prop_promotion_data'</span></div></pre></td></tr></table></figure>

<ul>
<li><strong>total rows</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="header">dbadmin:abc&gt; select count(*) from prop_promotion_data;</span></div><div class="line">+----------+</div><div class="line"><span class="header">| count(*) |</span></div><div class="line">+----------+</div><div class="line"><span class="header">| 52023757 |</span></div><div class="line">+----------+</div><div class="line">1 row in set (14.04 sec)</div></pre></td></tr></table></figure>

<ul>
<li><strong>index</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="method">dbadmin:</span>abc&gt; show index from prop_promotion_data;</div><div class="line">+---------------------+------------+--------------+--------------+------------------------+-----------+-------------+----------+--------+------+------------+---------+--------------</div><div class="line">-+</div><div class="line">| <span class="class">Table</span>               | <span class="class">Non_unique</span> | <span class="class">Key_name</span>     | <span class="class">Seq_in_index</span> | <span class="class">Column_name</span>            | <span class="class">Collation</span> | <span class="class">Cardinality</span> | <span class="class">Sub_part</span> | <span class="class">Packed</span> | <span class="class">Null</span> | <span class="class">Index_type</span> | <span class="class">Comment</span> | <span class="class">Index_comment</span></div><div class="line"> |</div><div class="line">+---------------------+------------+--------------+--------------+------------------------+-----------+-------------+----------+--------+------+------------+---------+--------------</div><div class="line">-+</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">0</span> | <span class="class">PRIMARY</span>      |            <span class="number">1</span> <span class="localvars">| id                     |</span> <span class="class">A</span>         |    <span class="number">51696652</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| cid          |</span>            <span class="number">1</span> <span class="localvars">| cid                    |</span> <span class="class">A</span>         |       <span class="number">47341</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| cid          |</span>            <span class="number">2</span> <span class="localvars">| report_date            |</span> <span class="class">A</span>         |     <span class="number">4308054</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| gid          |</span>            <span class="number">1</span> <span class="localvars">| gid                    |</span> <span class="class">A</span>         |       <span class="number">39016</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| gid          |</span>            <span class="number">2</span> <span class="localvars">| report_date            |</span> <span class="class">A</span>         |     <span class="number">6462081</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| report_date  |</span>            <span class="number">1</span> <span class="localvars">| report_date            |</span> <span class="class">A</span>         |      <span class="number">106591</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| cst_date     |</span>            <span class="number">1</span> <span class="localvars">| cst_broker_company_ids |</span> <span class="class">A</span>         |      <span class="number">181391</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| cst_date     |</span>            <span class="number">2</span> <span class="localvars">| report_date            |</span> <span class="class">A</span>         |    <span class="number">25848326</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| idx_brokerid |</span>            <span class="number">1</span> <span class="localvars">| brokerid               |</span> <span class="class">A</span>         |      <span class="number">555877</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| idx_brokerid |</span>            <span class="number">2</span> <span class="localvars">| report_date            |</span> <span class="class">A</span>         |    <span class="number">51696652</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line">+---------------------+------------+--------------+--------------+------------------------+-----------+-------------+----------+--------+------+------------+---------+--------------</div><div class="line">-+</div><div class="line"><span class="number">10</span> rows in set (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>

<h2 id="问题1">问题1</h2>
<hr>
<ul>
<li><strong>SQL 1</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="header">dbadmin:abc&gt; explain select distinct  `brokerid`  from `prop_promotion_data`  where `cst_broker_company_ids` in ( '59494' , '59499' , '59502' , '59727' , '60119' , '93204' )  and `report_date` &gt;= '20141101'  and `report_date` &lt;= '20141126'  order by `brokerid` desc limit 15,15;</span></div><div class="line">+----+-------------+---------------------+-------+-------------------------------+----------+---------+------+----------+-------------+</div><div class="line"><span class="header">| id | select_type | table               | type  | possible_keys                 | key      | key_len | ref  | rows     | Extra       |</span></div><div class="line">+----+-------------+---------------------+-------+-------------------------------+----------+---------+------+----------+-------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | prop_promotion_data | index | report_date,brokerid,cst_date | brokerid | 8       | NULL | 51696652 | Using where |</span></div><div class="line">+----+-------------+---------------------+-------+-------------------------------+----------+---------+------+----------+-------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"><span class="header">dbadmin:abc&gt; show status like 'Han%';</span></div><div class="line">+----------------------------+----------+</div><div class="line"><span class="header">| Variable_name              | Value    |</span></div><div class="line">+----------------------------+----------+</div><div class="line">| Handler<span class="emphasis">_commit             | 1        |</span></div><div class="line">| Handler_delete             | 0        |</div><div class="line">| Handler<span class="emphasis">_discover           | 0        |</span></div><div class="line">| Handler_external<span class="emphasis">_lock      | 2        |</span></div><div class="line">| Handler_mrr<span class="emphasis">_init           | 0        |</span></div><div class="line">| Handler_prepare            | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>first         | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>key           | 1        |</div><div class="line">| Handler<span class="emphasis">_read_</span>last          | 1        |</div><div class="line">| Handler<span class="emphasis">_read_</span>next          | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>prev          | 45189200 |  --all index scan</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd           | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd<span class="emphasis">_next      | 1        |</span></div><div class="line">| Handler_rollback           | 0        |</div><div class="line">| Handler<span class="emphasis">_savepoint          | 0        |</span></div><div class="line">| Handler_savepoint<span class="emphasis">_rollback | 0        |</span></div><div class="line">| Handler_update             | 0        |</div><div class="line"><span class="header">| Handler_write              | 0        |</span></div><div class="line">+----------------------------+----------+</div><div class="line">18 rows in set (0.00 sec)</div><div class="line"></div><div class="line">执行时间：15 rows in set (5 min 36.12 sec)</div></pre></td></tr></table></figure>

<ul>
<li><strong>SQL 2</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">dbadmin:abc&gt; explain select distinct  <span class="smartquote">`brokerid`  from `prop_promotion_data` force index(brokerid) where `cst_broker_company_ids` in ( '</span>59494' , <span class="emphasis">'59499'</span> , <span class="emphasis">'59502'</span> , <span class="emphasis">'59727'</span> , <span class="emphasis">'60119'</span> , <span class="emphasis">'93204'</span> )  and <span class="smartquote">`report_date` &gt;= '</span>20141101'  and <span class="smartquote">`report_date` &lt;= '</span>20141126'  order by <span class="code">`brokerid`</span> desc limit 15,15</div><div class="line"><span class="header">    -&gt; ;</span></div><div class="line">+----+-------------+---------------------+-------+---------------+----------+---------+------+------+-------------+</div><div class="line"><span class="header">| id | select_type | table               | type  | possible_keys | key      | key_len | ref  | rows | Extra       |</span></div><div class="line">+----+-------------+---------------------+-------+---------------+----------+---------+------+------+-------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | prop_promotion_data | index | brokerid      | brokerid | 8       | NULL | 3300 | Using where |</span></div><div class="line">+----+-------------+---------------------+-------+---------------+----------+---------+------+------+-------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line"><span class="header">dbadmin:abc&gt; show status like 'Han%';</span></div><div class="line">+----------------------------+----------+</div><div class="line"><span class="header">| Variable_name              | Value    |</span></div><div class="line">+----------------------------+----------+</div><div class="line">| Handler<span class="emphasis">_commit             | 1        |</span></div><div class="line">| Handler_delete             | 0        |</div><div class="line">| Handler<span class="emphasis">_discover           | 0        |</span></div><div class="line">| Handler_external<span class="emphasis">_lock      | 2        |</span></div><div class="line">| Handler_mrr<span class="emphasis">_init           | 0        |</span></div><div class="line">| Handler_prepare            | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>first         | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>key           | 1        |</div><div class="line">| Handler<span class="emphasis">_read_</span>last          | 1        |</div><div class="line">| Handler<span class="emphasis">_read_</span>next          | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>prev          | 45189200 |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd           | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd<span class="emphasis">_next      | 0        |</span></div><div class="line">| Handler_rollback           | 0        |</div><div class="line">| Handler<span class="emphasis">_savepoint          | 0        |</span></div><div class="line">| Handler_savepoint<span class="emphasis">_rollback | 0        |</span></div><div class="line">| Handler_update             | 0        |</div><div class="line"><span class="header">| Handler_write              | 0        |</span></div><div class="line">+----------------------------+----------+</div><div class="line">18 rows in set (0.00 sec)</div><div class="line"></div><div class="line">执行时间：15 rows in set (5 min 38.85 sec)</div></pre></td></tr></table></figure>

<ul>
<li><strong>总结</strong></li>
</ul>
<ol>
<li>为什么explain中的rows不一样，最终的扫描的Handler_read_prev一样呢？</li>
</ol>
<p>哈哈，只能说explain 中的limit 欺骗了你。。。 <a href="http://dev.mysql.com/doc/refman/5.6/en/limit-optimization.html" target="_blank" rel="external">limit optimization</a></p>
<h2 id="问题二">问题二</h2>
<hr>
<p>针对以上案例，为什么Mysql 会选择brokerid 作为索引呢？为什么不用其他的索引呢？我们来强制指定看看</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">dbadmin:abc&gt; explain select distinct  <span class="smartquote">`brokerid`  from `prop_promotion_data` force index(cst_date) where `cst_broker_company_ids` in ( '</span>59494' , <span class="emphasis">'59499'</span> , <span class="emphasis">'59502'</span> , <span class="emphasis">'59727'</span> , <span class="emphasis">'60119'</span> , <span class="emphasis">'93204'</span> )  and <span class="smartquote">`report_date` &gt;= '</span>20141101'  and <span class="smartquote">`report_date` &lt;= '</span>20141126'  order by <span class="code">`brokerid`</span> desc limit 15,15</div><div class="line"><span class="header">    -&gt; ;</span></div><div class="line">+----+-------------+---------------------+------+-----------------------+------+---------+------+----------+----------------------------------------------+</div><div class="line"><span class="header">| id | select_type | table               | type | possible_keys         | key  | key_len | ref  | rows     | Extra                                        |</span></div><div class="line">+----+-------------+---------------------+------+-----------------------+------+---------+------+----------+----------------------------------------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | prop_promotion_data | ALL  | cst_date,idx_brokerid | NULL | NULL    | NULL | 51696652 | Using where; Using temporary; Using filesort |</span></div><div class="line">+----+-------------+---------------------+------+-----------------------+------+---------+------+----------+----------------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<p>看样子，还是不行？ 强制索引无效。。。怎么办？那我们就应该去看看Mysql到底是如何一步一步选择执行计划的，还好Mysql 5.6 提供了另外一种追踪途径 optimizer_trace</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET optimizer_trace=<span class="string">"enabled=on"</span>;</div><div class="line"></div><div class="line"><span class="attribute">SQL1</span>:</div><div class="line">select distinct  `<span class="javascript">brokerid</span>`  from `<span class="javascript">prop_promotion_data</span>`  where `<span class="javascript">cst_broker_company_ids</span>` <span class="keyword">in</span> ( <span class="string">'59494'</span> , <span class="string">'59499'</span> , <span class="string">'59502'</span> , <span class="string">'59727'</span> , <span class="string">'60119'</span> , <span class="string">'93204'</span> )  <span class="keyword">and</span> `<span class="javascript">report_date</span>` &gt;= <span class="string">'20141101'</span>  <span class="keyword">and</span> `<span class="javascript">report_date</span>` &lt;= <span class="string">'20141126'</span>  order <span class="keyword">by</span> `<span class="javascript">brokerid</span>` desc limit <span class="number">15</span>,<span class="number">15</span>;</div><div class="line"></div><div class="line">mysql&gt; SELECT trace FROM information_schema.OPTIMIZER_TRACE INTO outfile <span class="string">'trace.json'</span>;</div><div class="line"></div><div class="line">最终看到的jason时这样的(截取部分)：</div><div class="line">            <span class="string">"clause_processing"</span>: {\</div><div class="line">              <span class="string">"clause"</span>: <span class="string">"GROUP BY"</span>,\</div><div class="line">              <span class="string">"original_clause"</span>: <span class="string">"`prop_promotion_data`.`brokerid` desc"</span>,\</div><div class="line">              <span class="string">"items"</span>: [\</div><div class="line">                {\</div><div class="line">                  <span class="string">"item"</span>: <span class="string">"`prop_promotion_data`.`brokerid`"</span>\</div><div class="line">                }\</div><div class="line">              ],\</div><div class="line">              <span class="string">"resulting_clause_is_simple"</span>: <span class="literal">true</span>,\</div><div class="line">              <span class="string">"resulting_clause"</span>: <span class="string">"`prop_promotion_data`.`brokerid` desc"</span>\</div><div class="line">            }\</div><div class="line">          },\</div><div class="line">          {\</div><div class="line">            <span class="string">"refine_plan"</span>: [\</div><div class="line">              {\</div><div class="line">                <span class="string">"table"</span>: <span class="string">"`prop_promotion_data`"</span>,\</div><div class="line">                <span class="string">"access_type"</span>: <span class="string">"table_scan"</span>\</div><div class="line">              }\</div><div class="line">            ]\</div><div class="line">          },\</div><div class="line">          {\</div><div class="line">            <span class="string">"reconsidering_access_paths_for_index_ordering"</span>: {\</div><div class="line">              <span class="string">"clause"</span>: <span class="string">"GROUP BY"</span>,\</div><div class="line">              <span class="string">"index_order_summary"</span>: {\</div><div class="line">                <span class="string">"table"</span>: <span class="string">"`prop_promotion_data`"</span>,\</div><div class="line">                <span class="string">"index_provides_order"</span>: <span class="literal">true</span>,\</div><div class="line">                <span class="string">"order_direction"</span>: <span class="string">"desc"</span>,\</div><div class="line">                <span class="string">"index"</span>: <span class="string">"brokerid"</span>,\</div><div class="line">                <span class="string">"plan_changed"</span>: <span class="literal">true</span>,\</div><div class="line">                <span class="string">"access_type"</span>: <span class="string">"index_scan"</span>\</div></pre></td></tr></table></figure>

<p>大家可以很清晰的看到，Mysql在之前还是有很多可以选择的索引，但是最后<br>reconsidering_access_paths_for_index_ordering 中却选择了brokerid，访问路径为index_scan.<br>奇了个怪了，为啥？google了一把后，发现之前有类似的bug <a href="http://bugs.mysql.com/
bug.php?id=70245" target="_blank" rel="external">Bug #70245</a>,里面说eq_range_index_dive_limit 会影响range查询计划，官方文档确实也是这<br>么说的。But，无论我怎么设置eq_range_index_dive_limit的值，丝毫不会影响执行计划</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="header">dbadmin:abc&gt; select @@session.eq_range_index_dive_limit;</span></div><div class="line">+-------------------------------------+</div><div class="line"><span class="header">| @@session.eq_range_index_dive_limit |</span></div><div class="line">+-------------------------------------+</div><div class="line"><span class="header">|                                  10 |</span></div><div class="line">+-------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line">以上SQL测试均来自 @@session.eq<span class="emphasis">_range_</span>index<span class="emphasis">_dive_</span>limit。</div><div class="line"></div><div class="line">设置成200（&gt;in(N)）：set @@session.eq<span class="emphasis">_range_</span>index<span class="emphasis">_dive_</span>limit=200;</div><div class="line"></div><div class="line">设置成0(&lt;in(N))，set @@session.eq<span class="emphasis">_range_</span>index<span class="emphasis">_dive_</span>limit=0；</div><div class="line"></div><div class="line">设置成与IN列表中的个数(=in(N))： set @@session.eq<span class="emphasis">_range_</span>index<span class="emphasis">_dive_</span>limit=6；</div><div class="line"></div><div class="line">以上执行计划没有任何变化，跑出来的时间，和上面一样。</div></pre></td></tr></table></figure>

<p><strong>那怎么办呢？</strong></p>
<ul>
<li><strong>首先</strong></li>
</ul>
<p>既然brokerid干扰其优化器的选择，如果我将其drop掉,优化器是否能够选择正确的索引呢？</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">dbadmin:abc&gt; alter table prop<span class="emphasis">_promotion_</span>data drop index brokerid;</div><div class="line">Query OK, 0 rows affected (0.22 sec)</div><div class="line">Records: 0  Duplicates: 0  Warnings: 0</div><div class="line"></div><div class="line"><span class="header">dbadmin:abc&gt; explain select distinct  `brokerid`  from `prop_promotion_data`  where `cst_broker_company_ids` in ( '59494' , '59499' , '59502' , '59727' , '60119' , '93204' )  and `report_date` &gt;= '20141101'  and `report_date` &lt;= '20141126'  order by `brokerid` desc limit 15,15;</span></div><div class="line">+----+-------------+---------------------+-------+----------------------+----------+---------+------+------+--------------------------------------------------------+</div><div class="line"><span class="header">| id | select_type | table               | type  | possible_keys        | key      | key_len | ref  | rows | Extra                                                  |</span></div><div class="line">+----+-------------+---------------------+-------+----------------------+----------+---------+------+------+--------------------------------------------------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | prop_promotion_data | range | report_date,cst_date | cst_date | 8       | NULL |  780 | Using index condition; Using temporary; Using filesort |</span></div><div class="line">+----+-------------+---------------------+-------+----------------------+----------+---------+------+------+--------------------------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">dbadmin:abc&gt; flush status;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line"><span class="header">dbadmin:abc&gt; select distinct  `brokerid`  from `prop_promotion_data`  where `cst_broker_company_ids` in ( '59494' , '59499' , '59502' , '59727' , '60119' , '93204' )  and `report_date` &gt;= '20141101'  and `report_date` &lt;= '20141126'  order by `brokerid` desc limit 15,15;</span></div><div class="line">+----------+</div><div class="line"><span class="header">| brokerid |</span></div><div class="line">+----------+</div><div class="line">|  2112641 |</div><div class="line">|  2111870 |</div><div class="line">|  2076429 |</div><div class="line">|  2072897 |</div><div class="line">|  1988209 |</div><div class="line">|  1897956 |</div><div class="line">|  1816767 |</div><div class="line">|  1767494 |</div><div class="line">|  1754405 |</div><div class="line">|  1709879 |</div><div class="line">|  1628017 |</div><div class="line">|  1587473 |</div><div class="line">|  1582185 |</div><div class="line">|  1574712 |</div><div class="line"><span class="header">|  1562055 |</span></div><div class="line">+----------+</div><div class="line">15 rows in set (0.11 sec)</div><div class="line"></div><div class="line"><span class="header">dbadmin:abc&gt; show status like 'Hand%';</span></div><div class="line">+----------------------------+-------+</div><div class="line"><span class="header">| Variable_name              | Value |</span></div><div class="line">+----------------------------+-------+</div><div class="line">| Handler<span class="emphasis">_commit             | 1     |</span></div><div class="line">| Handler_delete             | 0     |</div><div class="line">| Handler<span class="emphasis">_discover           | 0     |</span></div><div class="line">| Handler_external<span class="emphasis">_lock      | 2     |</span></div><div class="line">| Handler_mrr<span class="emphasis">_init           | 0     |</span></div><div class="line">| Handler_prepare            | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>first         | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>key           | 6     |</div><div class="line">| Handler<span class="emphasis">_read_</span>last          | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>next          | 781   |</div><div class="line">| Handler<span class="emphasis">_read_</span>prev          | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd           | 30    |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd<span class="emphasis">_next      | 36    |</span></div><div class="line">| Handler_rollback           | 0     |</div><div class="line">| Handler<span class="emphasis">_savepoint          | 0     |</span></div><div class="line">| Handler_savepoint<span class="emphasis">_rollback | 0     |</span></div><div class="line">| Handler_update             | 0     |</div><div class="line"><span class="header">| Handler_write              | 781   |</span></div><div class="line">+----------------------------+-------+</div><div class="line">18 rows in set (0.00 sec)</div></pre></td></tr></table></figure>

<p><strong>果然，Mysql选择了正确的索引，跑起来还不错。但是那个索引要经常被用到，不能被删除，结果这条道路是走不通的。</strong></p>
<ul>
<li><strong>其次</strong></li>
</ul>
<p>再回头看看trace的选择，里面有关于”clause”: “GROUP BY”？  我就再想，是不是由于Group by的原因呢？不清楚，那就试试呗，于是将distinct去掉，试试看</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="header">dbadmin:abc&gt; explain select   `brokerid`  from `prop_promotion_data` force index(cst_date) where `cst_broker_company_ids` in ( '59494' , '59499' , '59502' , '59727' , '60119' , '93204' )  and `report_date` &gt;= '20141101'  and `report_date` &lt;= '20141126'  order by `brokerid` desc limit 15,15;</span></div><div class="line">+----+-------------+---------------------+-------+---------------+----------+---------+------+------+---------------------------------------+</div><div class="line"><span class="header">| id | select_type | table               | type  | possible_keys | key      | key_len | ref  | rows | Extra                                 |</span></div><div class="line">+----+-------------+---------------------+-------+---------------+----------+---------+------+------+---------------------------------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | prop_promotion_data | range | cst_date      | cst_date | 8       | NULL |  780 | Using index condition; Using filesort |</span></div><div class="line">+----+-------------+---------------------+-------+---------------+----------+---------+------+------+---------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line"><span class="header">dbadmin:abc&gt; show status like 'Hand%';</span></div><div class="line">+----------------------------+-------+</div><div class="line"><span class="header">| Variable_name              | Value |</span></div><div class="line">+----------------------------+-------+</div><div class="line">| Handler<span class="emphasis">_commit             | 1     |</span></div><div class="line">| Handler_delete             | 0     |</div><div class="line">| Handler<span class="emphasis">_discover           | 0     |</span></div><div class="line">| Handler_external<span class="emphasis">_lock      | 2     |</span></div><div class="line">| Handler_mrr<span class="emphasis">_init           | 0     |</span></div><div class="line">| Handler_prepare            | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>first         | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>key           | 6     |</div><div class="line">| Handler<span class="emphasis">_read_</span>last          | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>next          | 781   |</div><div class="line">| Handler<span class="emphasis">_read_</span>prev          | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd           | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd<span class="emphasis">_next      | 0     |</span></div><div class="line">| Handler_rollback           | 0     |</div><div class="line">| Handler<span class="emphasis">_savepoint          | 0     |</span></div><div class="line">| Handler_savepoint<span class="emphasis">_rollback | 0     |</span></div><div class="line">| Handler_update             | 0     |</div><div class="line"><span class="header">| Handler_write              | 0     |</span></div><div class="line">+----------------------------+-------+</div><div class="line">18 rows in set (0.00 sec)</div></pre></td></tr></table></figure>

<p>情况貌似好转了，但是这样子是不满足业务逻辑的呀。。。。<br>于是，再仔细看看SQL语句的，发现order by 和 group by 重合了，，，为啥不利用group by来排序呢？<br>so，SQL语句这样修改一下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="header">dbadmin:abc&gt; explain select   `brokerid`    from     `prop_promotion_data`  where `cst_broker_company_ids` in ( '59494' , '59499' , '59502' , '59727' , '60119' , '93204' )  and `report_date` &gt;= '20141101'  and `report_date` &lt;= '20141126'   group  by `brokerid` desc limit 15,15;</span></div><div class="line">+----+-------------+---------------------+-------+-----------------------------------+----------+---------+------+------+--------------------------------------------------------+</div><div class="line"><span class="header">| id | select_type | table               | type  | possible_keys                     | key      | key_len | ref  | rows | Extra                                                  |</span></div><div class="line">+----+-------------+---------------------+-------+-----------------------------------+----------+---------+------+------+--------------------------------------------------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | prop_promotion_data | range | report_date,cst_date,idx_brokerid | cst_date | 8       | NULL |  780 | Using index condition; Using temporary; Using filesort |</span></div><div class="line">+----+-------------+---------------------+-------+-----------------------------------+----------+---------+------+------+--------------------------------------------------------+</div><div class="line">1 row in set (0.01 sec)</div><div class="line"></div><div class="line"><span class="header">dbadmin:abc&gt; show status like 'Hand%';</span></div><div class="line">+----------------------------+-------+</div><div class="line"><span class="header">| Variable_name              | Value |</span></div><div class="line">+----------------------------+-------+</div><div class="line">| Handler<span class="emphasis">_commit             | 1     |</span></div><div class="line">| Handler_delete             | 0     |</div><div class="line">| Handler<span class="emphasis">_discover           | 0     |</span></div><div class="line">| Handler_external<span class="emphasis">_lock      | 2     |</span></div><div class="line">| Handler_mrr<span class="emphasis">_init           | 0     |</span></div><div class="line">| Handler_prepare            | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>first         | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>key           | 6     |</div><div class="line">| Handler<span class="emphasis">_read_</span>last          | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>next          | 781   |</div><div class="line">| Handler<span class="emphasis">_read_</span>prev          | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd           | 15    |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd<span class="emphasis">_next      | 36    |</span></div><div class="line">| Handler_rollback           | 0     |</div><div class="line">| Handler<span class="emphasis">_savepoint          | 0     |</span></div><div class="line">| Handler_savepoint<span class="emphasis">_rollback | 0     |</span></div><div class="line">| Handler_update             | 0     |</div><div class="line"><span class="header">| Handler_write              | 781   |</span></div><div class="line">+----------------------------+-------+</div><div class="line">18 rows in set (0.00 sec)</div></pre></td></tr></table></figure>

<ul>
<li><strong>从性能上看</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">优化前的SQL：</div><div class="line">dbadmin:abc&gt; select distinct  <span class="smartquote">`brokerid`  from `prop_promotion_data`  where `cst_broker_company_ids` in ( '</span>59494' , <span class="emphasis">'59499'</span> , <span class="emphasis">'59502'</span> , <span class="emphasis">'59727'</span> , <span class="emphasis">'60119'</span> , <span class="emphasis">'93204'</span> )  and <span class="smartquote">`report_date` &gt;= '</span>20141101'  and <span class="smartquote">`report_date` &lt;= '</span>20141126'  order by <span class="code">`brokerid`</span> desc limit 15,15;</div><div class="line"></div><div class="line"><span class="code">+----------+</span></div><div class="line"><span class="header">| brokerid |</span></div><div class="line">+----------+</div><div class="line">|  2112641 |</div><div class="line">|  2111870 |</div><div class="line">|  2076429 |</div><div class="line">|  2072897 |</div><div class="line">|  1988209 |</div><div class="line">|  1897956 |</div><div class="line">|  1816767 |</div><div class="line">|  1767494 |</div><div class="line">|  1754405 |</div><div class="line">|  1709879 |</div><div class="line">|  1628017 |</div><div class="line">|  1587473 |</div><div class="line">|  1582185 |</div><div class="line">|  1574712 |</div><div class="line"><span class="header">|  1562055 |</span></div><div class="line">+----------+</div><div class="line">15 rows in set (5 min 42.10 sec)</div><div class="line"></div><div class="line">优化后的SQL：</div><div class="line"><span class="header">dbadmin:abc&gt; select  `brokerid`  from `prop_promotion_data`  where `cst_broker_company_ids` in ( '59494' , '59499' , '59502' , '59727' , '60119' , '93204' )  and `report_date` &gt;= '20141101'  and `report_date` &lt;= '20141126' group by `brokerid` desc limit 15,15;</span></div><div class="line">+----------+</div><div class="line"><span class="header">| brokerid |</span></div><div class="line">+----------+</div><div class="line">|  2112641 |</div><div class="line">|  2111870 |</div><div class="line">|  2076429 |</div><div class="line">|  2072897 |</div><div class="line">|  1988209 |</div><div class="line">|  1897956 |</div><div class="line">|  1816767 |</div><div class="line">|  1767494 |</div><div class="line">|  1754405 |</div><div class="line">|  1709879 |</div><div class="line">|  1628017 |</div><div class="line">|  1587473 |</div><div class="line">|  1582185 |</div><div class="line">|  1574712 |</div><div class="line"><span class="header">|  1562055 |</span></div><div class="line">+----------+</div><div class="line">15 rows in set (0.01 sec)</div><div class="line"></div><div class="line"></div><div class="line">PS：为了保证SQL的效率的准确性，以上SQL均重启后第一次跑的时间为准。</div></pre></td></tr></table></figure>

<ul>
<li><p><strong>总结</strong></p>
<ol>
<li>distinct，orderby ，group by，limit 这几个条件放在一起，会给Mysql 优化器带来很大的负担，建议尽量不要这样使用。</li>
</ol>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/Keithlan/Keithlan.github.io/2015/07/14/mysql_group_order_limit/" data-id="vbz00bxhg5jk5alj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/07/14/mysql_shutdown_err/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2015/07/14/mysql_error_1293/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>




<section id="comments">
  <!-- Duoshuo Comment BEGIN -->
  <div class="ds-thread"></div>
    <script type="text/javascript">
      var duoshuoQuery = {short_name:"兰春"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = 'http://static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0]
          || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
  </script>
<!-- Duoshuo Comment END -->
</section>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL-Error/">MySQL Error</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/MySQL-Error/" style="font-size: NaNpx;">MySQL Error</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/07/14/mysql_shutdown_err/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/07/14/mysql_group_order_limit/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/07/14/mysql_error_1293/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/07/14/mysql_ulimit/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/07/14/mysql_replicate_rule/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<script src="/js/script.js" type="text/javascript"></script>


  </div>
</body>
</html>