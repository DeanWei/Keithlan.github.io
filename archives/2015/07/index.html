<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Archives: 2015/7 | Focus on Mysql,Focus on DB,Focus on Focus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description">
<meta property="og:type" content="website">
<meta property="og:title" content="Focus on Mysql,Focus on DB,Focus on Focus">
<meta property="og:url" content="https://github.com/Keithlan/Keithlan.github.io/archives/2015/07/">
<meta property="og:site_name" content="Focus on Mysql,Focus on DB,Focus on Focus">
<meta property="og:description">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Focus on Mysql,Focus on DB,Focus on Focus">
<meta name="twitter:description">

  
    <link rel="alternative" href="/atom.xml" title="Focus on Mysql,Focus on DB,Focus on Focus" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Focus on Mysql,Focus on DB,Focus on Focus</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:https://github.com/Keithlan/Keithlan.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-mysql_shutdown_err" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/14/mysql_shutdown_err/" class="article-date">
  <time datetime="2015-07-14T11:30:34.000Z" itemprop="datePublished">Jul 14 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="mysql_shutdown_异常处理和分析">mysql shutdown 异常处理和分析</h1>
<blockquote>
<p>任何东西都有结束的一天，当初分析过linux的开机与关机流程。现在遇到了mysql关机异常，顺便了解一下mysql的关机流程。</p>
</blockquote>
<h2 id="先了解一下mysql的shutdown流程">先了解一下mysql的shutdown流程</h2>
<hr>
<ol>
<li>The shutdown process is initiated.</li>
<li>The server creates a shutdown thread if necessary.</li>
<li>The server stops accepting new connections.</li>
<li>The server terminates current activity.</li>
<li>The server shuts down or closes storage engines.</li>
<li>The server exits.</li>
</ol>
<p>以上只是官方文档中介绍的一些基本的关机流程,正确的关机命令当然是mysqladmin -xx  shutdown 。接下来，我们来关注一下我们的问题</p>
<h2 id="问题描述">问题描述</h2>
<hr>
<p><strong>mysqladmin shutdown 不但没有关闭掉，反而会restart</strong></p>
<p>提示信息如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">150105 14<span class="pseudo">:50</span><span class="pseudo">:47</span> <span class="tag">mysqld_safe</span> <span class="tag">Number</span> <span class="tag">of</span> <span class="tag">processes</span> <span class="tag">running</span> <span class="tag">now</span>: 0</div><div class="line">150105 14<span class="pseudo">:50</span><span class="pseudo">:47</span> <span class="tag">mysqld_safe</span> <span class="tag">mysqld</span> <span class="tag">restarted</span></div></pre></td></tr></table></figure>

<p>齐了个怪了，我的参数明明是shutdown ，为什么提示信息是 restart呢？ 错误日志中也无明显错误， 程序Bug了？</p>
<p>唯一能关闭的方法就是： kill ， 这是非法的，我们当然不能这样做。</p>
<p>于是尝试了N种方法</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="bullet">* </span>可能是/usr/local/mysql/data/xxxx.pid文件没有写的权限</div><div class="line"><span class="bullet">* </span>可能进程里已经存在mysql进程</div><div class="line"><span class="bullet">* </span>可能是第二次在机器上安装mysql，有残余数据影响了服务的启动。</div><div class="line"><span class="bullet">* </span>mysql在启动时没有指定配置文件时会使用/etc/my.cnf配置文件，请打开这个文件查看在[mysqld]节下有没有指定数据目录(datadir)。</div><div class="line"><span class="bullet">* </span>skip-federated字段问题</div><div class="line"><span class="bullet">* </span>错误日志目录不存在</div><div class="line"><span class="bullet">* </span>selinux惹的祸，如果是centos系统，默认会开启selinux</div></pre></td></tr></table></figure>

<p>很不幸的是，都不是上述问题造成。既然google也找不到，那只能看源码了。</p>
<p>大家都知道，mysqld_safe 是 启动mysql的守护进程，我想89不离10，应该是由它重启的，那就一窥究竟吧。</p>
<p>源码文件如下： <a href="https://github.com/Keithlan/Keithlan.github.io/blob/master/github_md/Mysql/ERROR_HANDLE/mysql_shutdown/mysql_shutdown_err.md" target="_blank" rel="external">mysqld_safe</a></p>
<p>下面是部分重要的部分，特拿出来分析,其中添加了一些注释和一些方便调试的断点代码（add by keithlan）。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 后面就是用它启动的mysqld，通过logging变量区分记录日志的类型，分错误日志和系统日志syslog两种</span></div><div class="line"><span class="comment"># 最后的eval命令会解析 $cmd 中的值并执行命令</span></div><div class="line"><span class="function"><span class="title">eval_log_error</span></span> () {</div><div class="line">  cmd=<span class="string">"<span class="variable">$1</span>"</span></div><div class="line">  <span class="keyword">case</span> <span class="variable">$logging</span> <span class="keyword">in</span></div><div class="line">    file) cmd=<span class="string">"<span class="variable">$cmd</span> &gt;&gt; "</span>`shell_quote_string <span class="string">"<span class="variable">$err_log</span>"</span>`<span class="string">" 2&gt;&1"</span> ;;</div><div class="line">    syslog)</div><div class="line">      <span class="comment"># mysqld often prefixes its messages with a timestamp, which is</span></div><div class="line">      <span class="comment"># redundant when logging to syslog (which adds its own timestamp)</span></div><div class="line">      <span class="comment"># However, we don't strip the timestamp with sed here, because</span></div><div class="line">      <span class="comment"># sed buffers output (only GNU sed supports a -u (unbuffered) option)</span></div><div class="line">      <span class="comment"># which means that messages may not get sent to syslog until the</span></div><div class="line">      <span class="comment"># mysqld process quits.</span></div><div class="line">      cmd=<span class="string">"<span class="variable">$cmd</span> 2&gt;&1 | logger -t '<span class="variable">$syslog_tag_mysqld</span>' -p daemon.error"</span></div><div class="line">      ;;</div><div class="line">    *)</div><div class="line">      <span class="built_in">echo</span> <span class="string">"Internal program error (non-fatal):"</span> \</div><div class="line">           <span class="string">" unknown logging method '<span class="variable">$logging</span>'"</span> &gt;&<span class="number">2</span></div><div class="line">      ;;</div><div class="line">  <span class="keyword">esac</span></div><div class="line"></div><div class="line">  <span class="built_in">echo</span> <span class="string">"Running mysqld: [<span class="variable">$cmd</span>]"</span>   --add by Keithlan</div><div class="line">  <span class="built_in">eval</span> <span class="string">"<span class="variable">$cmd</span>"</span></div><div class="line">}</div><div class="line"></div><div class="line"><span class="comment"># 后台循环 执行mysqld</span></div><div class="line">log_notice <span class="string">"Starting <span class="variable">$MYSQLD</span> daemon with databases from <span class="variable">$DATADIR</span>"</span></div><div class="line"><span class="keyword">while</span> <span class="literal">true</span></div><div class="line"><span class="keyword">do</span></div><div class="line">  rm <span class="operator">-f</span> <span class="variable">$safe_mysql_unix_port</span> <span class="string">"<span class="variable">$pid_file</span>"</span>       <span class="comment"># Some extra safety # 保险起见，又删除了一次pid文件</span></div><div class="line">  log_notice <span class="string">"rm -f <span class="variable">$safe_mysql_unix_port</span> <span class="variable">$pid_file</span> !"</span>  <span class="comment">#add by Keithlan</span></div><div class="line"></div><div class="line">  <span class="built_in">eval</span>_log_error <span class="string">"<span class="variable">$cmd</span>"</span></div><div class="line">  log_notice <span class="string">" after running mysql "</span>                     <span class="comment">#add by Keithlan</span></div><div class="line">  last_pid=`ls <span class="operator">-l</span> /usr/local/mysql/var/`      <span class="comment">#add by Keithlan</span></div><div class="line">  log_notice <span class="string">" last_pid = <span class="variable">$last_pid</span> !!"</span>       <span class="comment">#add by Keithlan</span></div><div class="line"></div><div class="line">  <span class="comment"># 正常的shutdown 会删除pid文件，如果没有pid文件，会正常退出，如果有，则继续。</span></div><div class="line">  <span class="comment"># 可想而知，这是唯一跳出循环的地方，这里一定有猫腻。</span></div><div class="line">  <span class="keyword">if</span> test ! <span class="operator">-f</span> <span class="string">"<span class="variable">$pid_file</span>"</span>              <span class="comment"># This is removed if normal shutdown  </span></div><div class="line">  <span class="keyword">then</span></div><div class="line">    log_notice <span class="string">"<span class="variable">$pid_file</span>"</span>             <span class="comment">#add by Keithlan</span></div><div class="line">    <span class="keyword">break</span></div><div class="line">  <span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="comment"># mysqld_safe已经启动的处理方法，保证只有一个mysqld_safe程序启动</span></div><div class="line">  <span class="keyword">if</span> <span class="literal">true</span> && test <span class="variable">$KILL_MYSQLD</span> <span class="operator">-eq</span> <span class="number">1</span></div><div class="line">  <span class="keyword">then</span></div><div class="line">    <span class="comment"># Test if one process was hanging.</span></div><div class="line">    <span class="comment"># This is only a fix for Linux (running as base 3 mysqld processes)</span></div><div class="line">    <span class="comment"># but should work for the rest of the servers.</span></div><div class="line">    <span class="comment"># The only thing is ps x =&gt; redhat 5 gives warnings when using ps -x.</span></div><div class="line">    <span class="comment"># kill -9 is used or the process won't react on the kill.</span></div><div class="line">    <span class="comment"># 统计启动的mysqld进程的数目</span></div><div class="line">    numofproces=`ps xaww | grep -v <span class="string">"grep"</span> | grep <span class="string">"<span class="variable">$ledir</span>/<span class="variable">$MYSQLD</span>\&gt;"</span> | grep -c <span class="string">"pid-file=<span class="variable">$pid_file</span>"</span>`</div><div class="line"></div><div class="line">    log_notice <span class="string">"Number of processes running now: <span class="variable">$numofproces</span>"</span></div><div class="line">    I=<span class="number">1</span></div><div class="line">    <span class="keyword">while</span> test <span class="string">"<span class="variable">$I</span>"</span> -le <span class="string">"<span class="variable">$numofproces</span>"</span></div><div class="line">    <span class="keyword">do</span></div><div class="line">      <span class="comment"># 这个PROC的数据即是ps mysqld_safe程序的输出 第一个数字即为进程ID</span></div><div class="line">      PROC=`ps xaww | grep <span class="string">"<span class="variable">$ledir</span>/<span class="variable">$MYSQLD</span>\&gt;"</span> | grep -v <span class="string">"grep"</span> | grep <span class="string">"pid-file=<span class="variable">$pid_file</span>"</span> | sed -n <span class="string">'$p'</span>`</div><div class="line">	  <span class="comment"># 使用T来获取进程ID</span></div><div class="line">      <span class="keyword">for</span> T <span class="keyword">in</span> <span class="variable">$PROC</span></div><div class="line">      <span class="keyword">do</span></div><div class="line">        <span class="keyword">break</span></div><div class="line">      <span class="keyword">done</span></div><div class="line">      <span class="comment">#    echo "TEST $I - $T **"</span></div><div class="line">      <span class="comment"># kill掉该个mysqld_safe程序</span></div><div class="line">      <span class="keyword">if</span> kill -<span class="number">9</span> <span class="variable">$T</span></div><div class="line">      <span class="keyword">then</span></div><div class="line">        log_error <span class="string">"<span class="variable">$MYSQLD</span> process hanging, pid <span class="variable">$T</span> - killed"</span></div><div class="line">      <span class="keyword">else</span></div><div class="line">        <span class="keyword">break</span></div><div class="line">      <span class="keyword">fi</span></div><div class="line">      <span class="comment"># 每干掉一个mysqld_safe就把I加一，这样没有多余的mysqld_safe时就可以跳出循环了</span></div><div class="line">      I=`expr <span class="variable">$I</span> + <span class="number">1</span>`</div><div class="line">    <span class="keyword">done</span></div><div class="line">  <span class="keyword">fi</span></div><div class="line">  log_notice <span class="string">"mysqld restarted"</span></div><div class="line">  log_notice <span class="string">"Keithlan"</span></div><div class="line"></div><div class="line"><span class="keyword">done</span></div><div class="line"></div><div class="line"><span class="comment">#mysql shutdown 成功，打印pid文件</span></div><div class="line">log_notice <span class="string">"mysqld from pid file <span class="variable">$pid_file</span> ended"</span></div></pre></td></tr></table></figure>

<p>简单描述一下过程就是：myqsld_safe 会用eval去启动mysqld，再后台运行，知道接受到kill 命令，或者shutdown 进程来kill掉它。<br>如果是非正常kill，mysqld_safe 会一直监控，将mysqld进程 restart起来。</p>
<p>经过调试后，手动去rm -f 掉pid文件， 然后再mysqladmin shutdown，是可以正常关闭的，很明显，就能定位到问题就出在pid上。为什么mysqladmin 进程shutdown的时候没有删除掉pid文件呢？ 首先可以排除掉权限等问题，因为既然能够create pid，当然可以delete pid咯。问题一定是mysqladmin 哪个地方出问题了，果然，根据线索找到mysqladmin 代码中断言出现问题Failing assertion: UT_LIST_GET_LEN(rseg-&gt;update_undo_list) == 0，网上搜了一堆的bug。 后来，想想，是不是表空间出了问题,mysql shutdown的时候回去回收表空间记录，如果回收不成功，导致不能normal shutdown，导致无法删除掉pid文件。 于是，将表空间重建后，问题消失。</p>
<h2 id="总结">总结</h2>
<hr>
<p>由于时间成本的问题，没能去详细了解mysqladmin 和 table space 的关系，但是却对mysql 的shutdown 流程有了进一步的认识，总算对自己有了一点交代。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/Keithlan/Keithlan.github.io/2015/07/14/mysql_shutdown_err/" data-id="qb3be99ay6ooxsd0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>





  
    <article id="post-mysql_group_order_limit" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/14/mysql_group_order_limit/" class="article-date">
  <time datetime="2015-07-14T11:30:10.000Z" itemprop="datePublished">Jul 14 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Mysql_5-6_执行计划错误案例分析">Mysql 5.6 执行计划错误案例分析</h1>
<blockquote>
<p>Depending on the details of your tables, columns, indexes, and the conditions in<br>your WHERE clause, the MySQL optimizer considers many techniques to efficiently<br>perform the lookups involved in an SQL query. A query on a huge table can be<br>performed without reading all the rows; a join involving several tables can be performed without comparing every combination of rows. The set of operations that the optimizer chooses to perform the most efficient query is called the “query execution plan”, also known as the EXPLAIN plan. Your goals are to recognize the aspects of the EXPLAIN plan that indicate a query is optimized well, and to learn the SQL syntax and indexing techniques to improve the plan if you see some inefficient operations.</p>
</blockquote>
<p><a href="http://dev.mysql.com/doc/refman/5.5/en/execution-plan-information.html" target="_blank" rel="external">Understanding the Query Execution Plan</a></p>
<h2 id="前提">前提</h2>
<hr>
<p>Mysql 优化器本就是为了优化SQL语句的查找路径而存在，当优化器足够智能的时候，这是一件美事。但是，如果优化器犯二的时候呢？有的时候执行计划看上去非常好，但是慢的无可救药。有的时候执行计划看上去很差，却跑的很欢。  接下来我们一起来看一下下面的例子：</p>
<ul>
<li><strong>表结构</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`prop_promotion_data`</span> (</span></div><div class="line">  <span class="string">`id`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`brokerid`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'经纪人id'</span>,</div><div class="line">  <span class="string">`groupid`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'组id'</span>,</div><div class="line">  <span class="string">`cid`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'总帐号id'</span>,</div><div class="line">  <span class="string">`gid`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'组帐号id'</span>,</div><div class="line">  <span class="string">`fix_prop_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'定价推广房源总数'</span>,</div><div class="line">  <span class="string">`more_10hours_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'定价推广超过10小时房源数'</span>,</div><div class="line">  <span class="string">`new_add_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'每天新增定价推广房源数'</span>,</div><div class="line">  <span class="string">`multi_map_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'多图房源数'</span>,</div><div class="line">  <span class="string">`fix_clicks`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'定价推广房源点击量'</span>,</div><div class="line">  <span class="string">`fix_consume`</span> <span class="built_in">float</span>(<span class="number">8</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'定价推广花费'</span>,</div><div class="line">  <span class="string">`bid_prop_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'竞价推广房源数'</span>,</div><div class="line">  <span class="string">`bid_clicks`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'竞价点击量'</span>,</div><div class="line">  <span class="string">`bid_consume`</span> <span class="built_in">float</span>(<span class="number">8</span>,<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'竞价推广花费'</span>,</div><div class="line">  <span class="string">`report_date`</span> <span class="built_in">int</span>(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'统计日期'</span>,</div><div class="line">  <span class="string">`last_update`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'最后更新时间'</span>,</div><div class="line">  <span class="string">`cst_broker_company_ids`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'关联anjuke_db.ajk_brokerextend中的cst_broker_company_id'</span>,</div><div class="line">  <span class="string">`new_fix_multi_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'新增定价多图房源'</span>,</div><div class="line">  <span class="string">`new_bid_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'新增竞价房源数'</span>,</div><div class="line">  <span class="string">`bid_multi_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'竞价多图房源'</span>,</div><div class="line">  <span class="string">`new_bid_multi_num`</span> mediumint(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'新增竞价多图房源'</span>,</div><div class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="string">`id`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`cid`</span> (<span class="string">`cid`</span>,<span class="string">`report_date`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`gid`</span> (<span class="string">`gid`</span>,<span class="string">`report_date`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`report_date`</span> (<span class="string">`report_date`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`brokerid`</span> (<span class="string">`brokerid`</span>,<span class="string">`report_date`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`cst_date`</span> (<span class="string">`cst_broker_company_ids`</span>,<span class="string">`report_date`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">57230309</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 COMMENT=<span class="string">'prop_promotion_data'</span></div></pre></td></tr></table></figure>

<ul>
<li><strong>total rows</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="header">dbadmin:abc&gt; select count(*) from prop_promotion_data;</span></div><div class="line">+----------+</div><div class="line"><span class="header">| count(*) |</span></div><div class="line">+----------+</div><div class="line"><span class="header">| 52023757 |</span></div><div class="line">+----------+</div><div class="line">1 row in set (14.04 sec)</div></pre></td></tr></table></figure>

<ul>
<li><strong>index</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="method">dbadmin:</span>abc&gt; show index from prop_promotion_data;</div><div class="line">+---------------------+------------+--------------+--------------+------------------------+-----------+-------------+----------+--------+------+------------+---------+--------------</div><div class="line">-+</div><div class="line">| <span class="class">Table</span>               | <span class="class">Non_unique</span> | <span class="class">Key_name</span>     | <span class="class">Seq_in_index</span> | <span class="class">Column_name</span>            | <span class="class">Collation</span> | <span class="class">Cardinality</span> | <span class="class">Sub_part</span> | <span class="class">Packed</span> | <span class="class">Null</span> | <span class="class">Index_type</span> | <span class="class">Comment</span> | <span class="class">Index_comment</span></div><div class="line"> |</div><div class="line">+---------------------+------------+--------------+--------------+------------------------+-----------+-------------+----------+--------+------+------------+---------+--------------</div><div class="line">-+</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">0</span> | <span class="class">PRIMARY</span>      |            <span class="number">1</span> <span class="localvars">| id                     |</span> <span class="class">A</span>         |    <span class="number">51696652</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| cid          |</span>            <span class="number">1</span> <span class="localvars">| cid                    |</span> <span class="class">A</span>         |       <span class="number">47341</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| cid          |</span>            <span class="number">2</span> <span class="localvars">| report_date            |</span> <span class="class">A</span>         |     <span class="number">4308054</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| gid          |</span>            <span class="number">1</span> <span class="localvars">| gid                    |</span> <span class="class">A</span>         |       <span class="number">39016</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| gid          |</span>            <span class="number">2</span> <span class="localvars">| report_date            |</span> <span class="class">A</span>         |     <span class="number">6462081</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| report_date  |</span>            <span class="number">1</span> <span class="localvars">| report_date            |</span> <span class="class">A</span>         |      <span class="number">106591</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| cst_date     |</span>            <span class="number">1</span> <span class="localvars">| cst_broker_company_ids |</span> <span class="class">A</span>         |      <span class="number">181391</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| cst_date     |</span>            <span class="number">2</span> <span class="localvars">| report_date            |</span> <span class="class">A</span>         |    <span class="number">25848326</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| idx_brokerid |</span>            <span class="number">1</span> <span class="localvars">| brokerid               |</span> <span class="class">A</span>         |      <span class="number">555877</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line"><span class="localvars">| prop_promotion_data |</span>          <span class="number">1</span> <span class="localvars">| idx_brokerid |</span>            <span class="number">2</span> <span class="localvars">| report_date            |</span> <span class="class">A</span>         |    <span class="number">51696652</span> |     <span class="class">NULL</span> | <span class="class">NULL</span>   |      | <span class="class">BTREE</span>      |         |</div><div class="line"> |</div><div class="line">+---------------------+------------+--------------+--------------+------------------------+-----------+-------------+----------+--------+------+------------+---------+--------------</div><div class="line">-+</div><div class="line"><span class="number">10</span> rows in set (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>

<h2 id="问题1">问题1</h2>
<hr>
<ul>
<li><strong>SQL 1</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="header">dbadmin:abc&gt; explain select distinct  `brokerid`  from `prop_promotion_data`  where `cst_broker_company_ids` in ( '59494' , '59499' , '59502' , '59727' , '60119' , '93204' )  and `report_date` &gt;= '20141101'  and `report_date` &lt;= '20141126'  order by `brokerid` desc limit 15,15;</span></div><div class="line">+----+-------------+---------------------+-------+-------------------------------+----------+---------+------+----------+-------------+</div><div class="line"><span class="header">| id | select_type | table               | type  | possible_keys                 | key      | key_len | ref  | rows     | Extra       |</span></div><div class="line">+----+-------------+---------------------+-------+-------------------------------+----------+---------+------+----------+-------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | prop_promotion_data | index | report_date,brokerid,cst_date | brokerid | 8       | NULL | 51696652 | Using where |</span></div><div class="line">+----+-------------+---------------------+-------+-------------------------------+----------+---------+------+----------+-------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"><span class="header">dbadmin:abc&gt; show status like 'Han%';</span></div><div class="line">+----------------------------+----------+</div><div class="line"><span class="header">| Variable_name              | Value    |</span></div><div class="line">+----------------------------+----------+</div><div class="line">| Handler<span class="emphasis">_commit             | 1        |</span></div><div class="line">| Handler_delete             | 0        |</div><div class="line">| Handler<span class="emphasis">_discover           | 0        |</span></div><div class="line">| Handler_external<span class="emphasis">_lock      | 2        |</span></div><div class="line">| Handler_mrr<span class="emphasis">_init           | 0        |</span></div><div class="line">| Handler_prepare            | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>first         | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>key           | 1        |</div><div class="line">| Handler<span class="emphasis">_read_</span>last          | 1        |</div><div class="line">| Handler<span class="emphasis">_read_</span>next          | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>prev          | 45189200 |  --all index scan</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd           | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd<span class="emphasis">_next      | 1        |</span></div><div class="line">| Handler_rollback           | 0        |</div><div class="line">| Handler<span class="emphasis">_savepoint          | 0        |</span></div><div class="line">| Handler_savepoint<span class="emphasis">_rollback | 0        |</span></div><div class="line">| Handler_update             | 0        |</div><div class="line"><span class="header">| Handler_write              | 0        |</span></div><div class="line">+----------------------------+----------+</div><div class="line">18 rows in set (0.00 sec)</div><div class="line"></div><div class="line">执行时间：15 rows in set (5 min 36.12 sec)</div></pre></td></tr></table></figure>

<ul>
<li><strong>SQL 2</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">dbadmin:abc&gt; explain select distinct  <span class="smartquote">`brokerid`  from `prop_promotion_data` force index(brokerid) where `cst_broker_company_ids` in ( '</span>59494' , <span class="emphasis">'59499'</span> , <span class="emphasis">'59502'</span> , <span class="emphasis">'59727'</span> , <span class="emphasis">'60119'</span> , <span class="emphasis">'93204'</span> )  and <span class="smartquote">`report_date` &gt;= '</span>20141101'  and <span class="smartquote">`report_date` &lt;= '</span>20141126'  order by <span class="code">`brokerid`</span> desc limit 15,15</div><div class="line"><span class="header">    -&gt; ;</span></div><div class="line">+----+-------------+---------------------+-------+---------------+----------+---------+------+------+-------------+</div><div class="line"><span class="header">| id | select_type | table               | type  | possible_keys | key      | key_len | ref  | rows | Extra       |</span></div><div class="line">+----+-------------+---------------------+-------+---------------+----------+---------+------+------+-------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | prop_promotion_data | index | brokerid      | brokerid | 8       | NULL | 3300 | Using where |</span></div><div class="line">+----+-------------+---------------------+-------+---------------+----------+---------+------+------+-------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line"><span class="header">dbadmin:abc&gt; show status like 'Han%';</span></div><div class="line">+----------------------------+----------+</div><div class="line"><span class="header">| Variable_name              | Value    |</span></div><div class="line">+----------------------------+----------+</div><div class="line">| Handler<span class="emphasis">_commit             | 1        |</span></div><div class="line">| Handler_delete             | 0        |</div><div class="line">| Handler<span class="emphasis">_discover           | 0        |</span></div><div class="line">| Handler_external<span class="emphasis">_lock      | 2        |</span></div><div class="line">| Handler_mrr<span class="emphasis">_init           | 0        |</span></div><div class="line">| Handler_prepare            | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>first         | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>key           | 1        |</div><div class="line">| Handler<span class="emphasis">_read_</span>last          | 1        |</div><div class="line">| Handler<span class="emphasis">_read_</span>next          | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>prev          | 45189200 |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd           | 0        |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd<span class="emphasis">_next      | 0        |</span></div><div class="line">| Handler_rollback           | 0        |</div><div class="line">| Handler<span class="emphasis">_savepoint          | 0        |</span></div><div class="line">| Handler_savepoint<span class="emphasis">_rollback | 0        |</span></div><div class="line">| Handler_update             | 0        |</div><div class="line"><span class="header">| Handler_write              | 0        |</span></div><div class="line">+----------------------------+----------+</div><div class="line">18 rows in set (0.00 sec)</div><div class="line"></div><div class="line">执行时间：15 rows in set (5 min 38.85 sec)</div></pre></td></tr></table></figure>

<ul>
<li><strong>总结</strong></li>
</ul>
<ol>
<li>为什么explain中的rows不一样，最终的扫描的Handler_read_prev一样呢？</li>
</ol>
<p>哈哈，只能说explain 中的limit 欺骗了你。。。 <a href="http://dev.mysql.com/doc/refman/5.6/en/limit-optimization.html" target="_blank" rel="external">limit optimization</a></p>
<h2 id="问题二">问题二</h2>
<hr>
<p>针对以上案例，为什么Mysql 会选择brokerid 作为索引呢？为什么不用其他的索引呢？我们来强制指定看看</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">dbadmin:abc&gt; explain select distinct  <span class="smartquote">`brokerid`  from `prop_promotion_data` force index(cst_date) where `cst_broker_company_ids` in ( '</span>59494' , <span class="emphasis">'59499'</span> , <span class="emphasis">'59502'</span> , <span class="emphasis">'59727'</span> , <span class="emphasis">'60119'</span> , <span class="emphasis">'93204'</span> )  and <span class="smartquote">`report_date` &gt;= '</span>20141101'  and <span class="smartquote">`report_date` &lt;= '</span>20141126'  order by <span class="code">`brokerid`</span> desc limit 15,15</div><div class="line"><span class="header">    -&gt; ;</span></div><div class="line">+----+-------------+---------------------+------+-----------------------+------+---------+------+----------+----------------------------------------------+</div><div class="line"><span class="header">| id | select_type | table               | type | possible_keys         | key  | key_len | ref  | rows     | Extra                                        |</span></div><div class="line">+----+-------------+---------------------+------+-----------------------+------+---------+------+----------+----------------------------------------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | prop_promotion_data | ALL  | cst_date,idx_brokerid | NULL | NULL    | NULL | 51696652 | Using where; Using temporary; Using filesort |</span></div><div class="line">+----+-------------+---------------------+------+-----------------------+------+---------+------+----------+----------------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<p>看样子，还是不行？ 强制索引无效。。。怎么办？那我们就应该去看看Mysql到底是如何一步一步选择执行计划的，还好Mysql 5.6 提供了另外一种追踪途径 optimizer_trace</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">mysql&gt; SET optimizer_trace=<span class="string">"enabled=on"</span>;</div><div class="line"></div><div class="line"><span class="attribute">SQL1</span>:</div><div class="line">select distinct  `<span class="javascript">brokerid</span>`  from `<span class="javascript">prop_promotion_data</span>`  where `<span class="javascript">cst_broker_company_ids</span>` <span class="keyword">in</span> ( <span class="string">'59494'</span> , <span class="string">'59499'</span> , <span class="string">'59502'</span> , <span class="string">'59727'</span> , <span class="string">'60119'</span> , <span class="string">'93204'</span> )  <span class="keyword">and</span> `<span class="javascript">report_date</span>` &gt;= <span class="string">'20141101'</span>  <span class="keyword">and</span> `<span class="javascript">report_date</span>` &lt;= <span class="string">'20141126'</span>  order <span class="keyword">by</span> `<span class="javascript">brokerid</span>` desc limit <span class="number">15</span>,<span class="number">15</span>;</div><div class="line"></div><div class="line">mysql&gt; SELECT trace FROM information_schema.OPTIMIZER_TRACE INTO outfile <span class="string">'trace.json'</span>;</div><div class="line"></div><div class="line">最终看到的jason时这样的(截取部分)：</div><div class="line">            <span class="string">"clause_processing"</span>: {\</div><div class="line">              <span class="string">"clause"</span>: <span class="string">"GROUP BY"</span>,\</div><div class="line">              <span class="string">"original_clause"</span>: <span class="string">"`prop_promotion_data`.`brokerid` desc"</span>,\</div><div class="line">              <span class="string">"items"</span>: [\</div><div class="line">                {\</div><div class="line">                  <span class="string">"item"</span>: <span class="string">"`prop_promotion_data`.`brokerid`"</span>\</div><div class="line">                }\</div><div class="line">              ],\</div><div class="line">              <span class="string">"resulting_clause_is_simple"</span>: <span class="literal">true</span>,\</div><div class="line">              <span class="string">"resulting_clause"</span>: <span class="string">"`prop_promotion_data`.`brokerid` desc"</span>\</div><div class="line">            }\</div><div class="line">          },\</div><div class="line">          {\</div><div class="line">            <span class="string">"refine_plan"</span>: [\</div><div class="line">              {\</div><div class="line">                <span class="string">"table"</span>: <span class="string">"`prop_promotion_data`"</span>,\</div><div class="line">                <span class="string">"access_type"</span>: <span class="string">"table_scan"</span>\</div><div class="line">              }\</div><div class="line">            ]\</div><div class="line">          },\</div><div class="line">          {\</div><div class="line">            <span class="string">"reconsidering_access_paths_for_index_ordering"</span>: {\</div><div class="line">              <span class="string">"clause"</span>: <span class="string">"GROUP BY"</span>,\</div><div class="line">              <span class="string">"index_order_summary"</span>: {\</div><div class="line">                <span class="string">"table"</span>: <span class="string">"`prop_promotion_data`"</span>,\</div><div class="line">                <span class="string">"index_provides_order"</span>: <span class="literal">true</span>,\</div><div class="line">                <span class="string">"order_direction"</span>: <span class="string">"desc"</span>,\</div><div class="line">                <span class="string">"index"</span>: <span class="string">"brokerid"</span>,\</div><div class="line">                <span class="string">"plan_changed"</span>: <span class="literal">true</span>,\</div><div class="line">                <span class="string">"access_type"</span>: <span class="string">"index_scan"</span>\</div></pre></td></tr></table></figure>

<p>大家可以很清晰的看到，Mysql在之前还是有很多可以选择的索引，但是最后<br>reconsidering_access_paths_for_index_ordering 中却选择了brokerid，访问路径为index_scan.<br>奇了个怪了，为啥？google了一把后，发现之前有类似的bug <a href="http://bugs.mysql.com/
bug.php?id=70245" target="_blank" rel="external">Bug #70245</a>,里面说eq_range_index_dive_limit 会影响range查询计划，官方文档确实也是这<br>么说的。But，无论我怎么设置eq_range_index_dive_limit的值，丝毫不会影响执行计划</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="header">dbadmin:abc&gt; select @@session.eq_range_index_dive_limit;</span></div><div class="line">+-------------------------------------+</div><div class="line"><span class="header">| @@session.eq_range_index_dive_limit |</span></div><div class="line">+-------------------------------------+</div><div class="line"><span class="header">|                                  10 |</span></div><div class="line">+-------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line">以上SQL测试均来自 @@session.eq<span class="emphasis">_range_</span>index<span class="emphasis">_dive_</span>limit。</div><div class="line"></div><div class="line">设置成200（&gt;in(N)）：set @@session.eq<span class="emphasis">_range_</span>index<span class="emphasis">_dive_</span>limit=200;</div><div class="line"></div><div class="line">设置成0(&lt;in(N))，set @@session.eq<span class="emphasis">_range_</span>index<span class="emphasis">_dive_</span>limit=0；</div><div class="line"></div><div class="line">设置成与IN列表中的个数(=in(N))： set @@session.eq<span class="emphasis">_range_</span>index<span class="emphasis">_dive_</span>limit=6；</div><div class="line"></div><div class="line">以上执行计划没有任何变化，跑出来的时间，和上面一样。</div></pre></td></tr></table></figure>

<p><strong>那怎么办呢？</strong></p>
<ul>
<li><strong>首先</strong></li>
</ul>
<p>既然brokerid干扰其优化器的选择，如果我将其drop掉,优化器是否能够选择正确的索引呢？</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">dbadmin:abc&gt; alter table prop<span class="emphasis">_promotion_</span>data drop index brokerid;</div><div class="line">Query OK, 0 rows affected (0.22 sec)</div><div class="line">Records: 0  Duplicates: 0  Warnings: 0</div><div class="line"></div><div class="line"><span class="header">dbadmin:abc&gt; explain select distinct  `brokerid`  from `prop_promotion_data`  where `cst_broker_company_ids` in ( '59494' , '59499' , '59502' , '59727' , '60119' , '93204' )  and `report_date` &gt;= '20141101'  and `report_date` &lt;= '20141126'  order by `brokerid` desc limit 15,15;</span></div><div class="line">+----+-------------+---------------------+-------+----------------------+----------+---------+------+------+--------------------------------------------------------+</div><div class="line"><span class="header">| id | select_type | table               | type  | possible_keys        | key      | key_len | ref  | rows | Extra                                                  |</span></div><div class="line">+----+-------------+---------------------+-------+----------------------+----------+---------+------+------+--------------------------------------------------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | prop_promotion_data | range | report_date,cst_date | cst_date | 8       | NULL |  780 | Using index condition; Using temporary; Using filesort |</span></div><div class="line">+----+-------------+---------------------+-------+----------------------+----------+---------+------+------+--------------------------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">dbadmin:abc&gt; flush status;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line"><span class="header">dbadmin:abc&gt; select distinct  `brokerid`  from `prop_promotion_data`  where `cst_broker_company_ids` in ( '59494' , '59499' , '59502' , '59727' , '60119' , '93204' )  and `report_date` &gt;= '20141101'  and `report_date` &lt;= '20141126'  order by `brokerid` desc limit 15,15;</span></div><div class="line">+----------+</div><div class="line"><span class="header">| brokerid |</span></div><div class="line">+----------+</div><div class="line">|  2112641 |</div><div class="line">|  2111870 |</div><div class="line">|  2076429 |</div><div class="line">|  2072897 |</div><div class="line">|  1988209 |</div><div class="line">|  1897956 |</div><div class="line">|  1816767 |</div><div class="line">|  1767494 |</div><div class="line">|  1754405 |</div><div class="line">|  1709879 |</div><div class="line">|  1628017 |</div><div class="line">|  1587473 |</div><div class="line">|  1582185 |</div><div class="line">|  1574712 |</div><div class="line"><span class="header">|  1562055 |</span></div><div class="line">+----------+</div><div class="line">15 rows in set (0.11 sec)</div><div class="line"></div><div class="line"><span class="header">dbadmin:abc&gt; show status like 'Hand%';</span></div><div class="line">+----------------------------+-------+</div><div class="line"><span class="header">| Variable_name              | Value |</span></div><div class="line">+----------------------------+-------+</div><div class="line">| Handler<span class="emphasis">_commit             | 1     |</span></div><div class="line">| Handler_delete             | 0     |</div><div class="line">| Handler<span class="emphasis">_discover           | 0     |</span></div><div class="line">| Handler_external<span class="emphasis">_lock      | 2     |</span></div><div class="line">| Handler_mrr<span class="emphasis">_init           | 0     |</span></div><div class="line">| Handler_prepare            | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>first         | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>key           | 6     |</div><div class="line">| Handler<span class="emphasis">_read_</span>last          | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>next          | 781   |</div><div class="line">| Handler<span class="emphasis">_read_</span>prev          | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd           | 30    |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd<span class="emphasis">_next      | 36    |</span></div><div class="line">| Handler_rollback           | 0     |</div><div class="line">| Handler<span class="emphasis">_savepoint          | 0     |</span></div><div class="line">| Handler_savepoint<span class="emphasis">_rollback | 0     |</span></div><div class="line">| Handler_update             | 0     |</div><div class="line"><span class="header">| Handler_write              | 781   |</span></div><div class="line">+----------------------------+-------+</div><div class="line">18 rows in set (0.00 sec)</div></pre></td></tr></table></figure>

<p><strong>果然，Mysql选择了正确的索引，跑起来还不错。但是那个索引要经常被用到，不能被删除，结果这条道路是走不通的。</strong></p>
<ul>
<li><strong>其次</strong></li>
</ul>
<p>再回头看看trace的选择，里面有关于”clause”: “GROUP BY”？  我就再想，是不是由于Group by的原因呢？不清楚，那就试试呗，于是将distinct去掉，试试看</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="header">dbadmin:abc&gt; explain select   `brokerid`  from `prop_promotion_data` force index(cst_date) where `cst_broker_company_ids` in ( '59494' , '59499' , '59502' , '59727' , '60119' , '93204' )  and `report_date` &gt;= '20141101'  and `report_date` &lt;= '20141126'  order by `brokerid` desc limit 15,15;</span></div><div class="line">+----+-------------+---------------------+-------+---------------+----------+---------+------+------+---------------------------------------+</div><div class="line"><span class="header">| id | select_type | table               | type  | possible_keys | key      | key_len | ref  | rows | Extra                                 |</span></div><div class="line">+----+-------------+---------------------+-------+---------------+----------+---------+------+------+---------------------------------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | prop_promotion_data | range | cst_date      | cst_date | 8       | NULL |  780 | Using index condition; Using filesort |</span></div><div class="line">+----+-------------+---------------------+-------+---------------+----------+---------+------+------+---------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line"><span class="header">dbadmin:abc&gt; show status like 'Hand%';</span></div><div class="line">+----------------------------+-------+</div><div class="line"><span class="header">| Variable_name              | Value |</span></div><div class="line">+----------------------------+-------+</div><div class="line">| Handler<span class="emphasis">_commit             | 1     |</span></div><div class="line">| Handler_delete             | 0     |</div><div class="line">| Handler<span class="emphasis">_discover           | 0     |</span></div><div class="line">| Handler_external<span class="emphasis">_lock      | 2     |</span></div><div class="line">| Handler_mrr<span class="emphasis">_init           | 0     |</span></div><div class="line">| Handler_prepare            | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>first         | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>key           | 6     |</div><div class="line">| Handler<span class="emphasis">_read_</span>last          | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>next          | 781   |</div><div class="line">| Handler<span class="emphasis">_read_</span>prev          | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd           | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd<span class="emphasis">_next      | 0     |</span></div><div class="line">| Handler_rollback           | 0     |</div><div class="line">| Handler<span class="emphasis">_savepoint          | 0     |</span></div><div class="line">| Handler_savepoint<span class="emphasis">_rollback | 0     |</span></div><div class="line">| Handler_update             | 0     |</div><div class="line"><span class="header">| Handler_write              | 0     |</span></div><div class="line">+----------------------------+-------+</div><div class="line">18 rows in set (0.00 sec)</div></pre></td></tr></table></figure>

<p>情况貌似好转了，但是这样子是不满足业务逻辑的呀。。。。<br>于是，再仔细看看SQL语句的，发现order by 和 group by 重合了，，，为啥不利用group by来排序呢？<br>so，SQL语句这样修改一下</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="header">dbadmin:abc&gt; explain select   `brokerid`    from     `prop_promotion_data`  where `cst_broker_company_ids` in ( '59494' , '59499' , '59502' , '59727' , '60119' , '93204' )  and `report_date` &gt;= '20141101'  and `report_date` &lt;= '20141126'   group  by `brokerid` desc limit 15,15;</span></div><div class="line">+----+-------------+---------------------+-------+-----------------------------------+----------+---------+------+------+--------------------------------------------------------+</div><div class="line"><span class="header">| id | select_type | table               | type  | possible_keys                     | key      | key_len | ref  | rows | Extra                                                  |</span></div><div class="line">+----+-------------+---------------------+-------+-----------------------------------+----------+---------+------+------+--------------------------------------------------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | prop_promotion_data | range | report_date,cst_date,idx_brokerid | cst_date | 8       | NULL |  780 | Using index condition; Using temporary; Using filesort |</span></div><div class="line">+----+-------------+---------------------+-------+-----------------------------------+----------+---------+------+------+--------------------------------------------------------+</div><div class="line">1 row in set (0.01 sec)</div><div class="line"></div><div class="line"><span class="header">dbadmin:abc&gt; show status like 'Hand%';</span></div><div class="line">+----------------------------+-------+</div><div class="line"><span class="header">| Variable_name              | Value |</span></div><div class="line">+----------------------------+-------+</div><div class="line">| Handler<span class="emphasis">_commit             | 1     |</span></div><div class="line">| Handler_delete             | 0     |</div><div class="line">| Handler<span class="emphasis">_discover           | 0     |</span></div><div class="line">| Handler_external<span class="emphasis">_lock      | 2     |</span></div><div class="line">| Handler_mrr<span class="emphasis">_init           | 0     |</span></div><div class="line">| Handler_prepare            | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>first         | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>key           | 6     |</div><div class="line">| Handler<span class="emphasis">_read_</span>last          | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>next          | 781   |</div><div class="line">| Handler<span class="emphasis">_read_</span>prev          | 0     |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd           | 15    |</div><div class="line">| Handler<span class="emphasis">_read_</span>rnd<span class="emphasis">_next      | 36    |</span></div><div class="line">| Handler_rollback           | 0     |</div><div class="line">| Handler<span class="emphasis">_savepoint          | 0     |</span></div><div class="line">| Handler_savepoint<span class="emphasis">_rollback | 0     |</span></div><div class="line">| Handler_update             | 0     |</div><div class="line"><span class="header">| Handler_write              | 781   |</span></div><div class="line">+----------------------------+-------+</div><div class="line">18 rows in set (0.00 sec)</div></pre></td></tr></table></figure>

<ul>
<li><strong>从性能上看</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">优化前的SQL：</div><div class="line">dbadmin:abc&gt; select distinct  <span class="smartquote">`brokerid`  from `prop_promotion_data`  where `cst_broker_company_ids` in ( '</span>59494' , <span class="emphasis">'59499'</span> , <span class="emphasis">'59502'</span> , <span class="emphasis">'59727'</span> , <span class="emphasis">'60119'</span> , <span class="emphasis">'93204'</span> )  and <span class="smartquote">`report_date` &gt;= '</span>20141101'  and <span class="smartquote">`report_date` &lt;= '</span>20141126'  order by <span class="code">`brokerid`</span> desc limit 15,15;</div><div class="line"></div><div class="line"><span class="code">+----------+</span></div><div class="line"><span class="header">| brokerid |</span></div><div class="line">+----------+</div><div class="line">|  2112641 |</div><div class="line">|  2111870 |</div><div class="line">|  2076429 |</div><div class="line">|  2072897 |</div><div class="line">|  1988209 |</div><div class="line">|  1897956 |</div><div class="line">|  1816767 |</div><div class="line">|  1767494 |</div><div class="line">|  1754405 |</div><div class="line">|  1709879 |</div><div class="line">|  1628017 |</div><div class="line">|  1587473 |</div><div class="line">|  1582185 |</div><div class="line">|  1574712 |</div><div class="line"><span class="header">|  1562055 |</span></div><div class="line">+----------+</div><div class="line">15 rows in set (5 min 42.10 sec)</div><div class="line"></div><div class="line">优化后的SQL：</div><div class="line"><span class="header">dbadmin:abc&gt; select  `brokerid`  from `prop_promotion_data`  where `cst_broker_company_ids` in ( '59494' , '59499' , '59502' , '59727' , '60119' , '93204' )  and `report_date` &gt;= '20141101'  and `report_date` &lt;= '20141126' group by `brokerid` desc limit 15,15;</span></div><div class="line">+----------+</div><div class="line"><span class="header">| brokerid |</span></div><div class="line">+----------+</div><div class="line">|  2112641 |</div><div class="line">|  2111870 |</div><div class="line">|  2076429 |</div><div class="line">|  2072897 |</div><div class="line">|  1988209 |</div><div class="line">|  1897956 |</div><div class="line">|  1816767 |</div><div class="line">|  1767494 |</div><div class="line">|  1754405 |</div><div class="line">|  1709879 |</div><div class="line">|  1628017 |</div><div class="line">|  1587473 |</div><div class="line">|  1582185 |</div><div class="line">|  1574712 |</div><div class="line"><span class="header">|  1562055 |</span></div><div class="line">+----------+</div><div class="line">15 rows in set (0.01 sec)</div><div class="line"></div><div class="line"></div><div class="line">PS：为了保证SQL的效率的准确性，以上SQL均重启后第一次跑的时间为准。</div></pre></td></tr></table></figure>

<ul>
<li><p><strong>总结</strong></p>
<ol>
<li>distinct，orderby ，group by，limit 这几个条件放在一起，会给Mysql 优化器带来很大的负担，建议尽量不要这样使用。</li>
</ol>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/Keithlan/Keithlan.github.io/2015/07/14/mysql_group_order_limit/" data-id="vbz00bxhg5jk5alj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>





  
    <article id="post-mysql_error_1293" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/14/mysql_error_1293/" class="article-date">
  <time datetime="2015-07-14T11:30:10.000Z" itemprop="datePublished">Jul 14 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="深入浅出timestamp">深入浅出timestamp</h1>
<hr>
<h2 id="前提">前提</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">对于timestamp相关的错误，之前也有耳闻，但是并没有详细去了解，导致昨天有位同事描述的错误场景不能及时回答，这说明自己对Mysql的理解还是知之甚少。故，这里详细谈谈timestamp</div></pre></td></tr></table></figure>

<h2 id="错误场景">错误场景</h2>
<hr>
<p>好了，这里直奔主题吧。昨天有位同事遇到的错误ERROR 1293 (HY000):</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">* Mysql version 5.1.54</div><div class="line"></div><div class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">table</span> lc_test_0(</span></div><div class="line">	<span class="string">`update_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'cms时间'</span> ,</div><div class="line">    <span class="string">`upload_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'上传时间'</span></div><div class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 COMMENT=<span class="string">'已推送客户列表'</span>;</div><div class="line"></div><div class="line">ERROR 1293 (HY000): Incorrect table definition; there can be only one TIMESTAMP column with CURRENT_TIMESTAMP in DEFAULT or ON <span class="operator"><span class="keyword">UPDATE</span> clause</span></div></pre></td></tr></table></figure>

<p>通过以上错误，查查手册就知道，timestamp类型不允许有两个CURRENT_TIMESTAMP作为default值。</p>
<p>既然如此，那我们就去掉一个呗</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">table</span> lc_test_3(</span></div><div class="line">    <span class="string">`upload_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'上传时间'</span>,</div><div class="line">	<span class="string">`update_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></div><div class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 COMMENT=<span class="string">'已推送客户列表'</span>;</div><div class="line"></div><div class="line">Query OK, 0 rows affected (0.00 sec)</div></pre></td></tr></table></figure>

<p>so easy，这不就解决了嘛。</p>
<p>可是问题真是这样嘛？有些同学比较严谨和认真，将两个字段的顺序对调一下，则</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">table</span> lc_test_2(</span></div><div class="line">	<span class="string">`update_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> ,</div><div class="line">    <span class="string">`upload_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'上传时间'</span></div><div class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 COMMENT=<span class="string">'已推送客户列表'</span>;</div><div class="line"></div><div class="line">ERROR 1293 (HY000): Incorrect table definition; there can be only one TIMESTAMP column with CURRENT_TIMESTAMP in DEFAULT or ON <span class="operator"><span class="keyword">UPDATE</span> clause</span></div></pre></td></tr></table></figure>

<p>你看看，问题又来了，这样彻底晕了，同样的建表语句，只是字段顺序变掉了，就错了？</p>
<p>莫非这是Mysql 的 BUG？ 去Mysql Buglist中去查查看，结果没有类似bug。</p>
<p>目前能想到的就是仔细去看看官方文档对于CURRENT_TIMESTAMP的描述</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">* Mysql <span class="number">5.1</span> *</div><div class="line"> </div><div class="line">One TIMESTAMP column <span class="operator">in</span> <span class="operator">a</span> table can have <span class="operator">the</span> current timestamp <span class="keyword">as</span> <span class="operator">the</span> default <span class="built_in">value</span> <span class="keyword">for</span> initializing <span class="operator">the</span> column, <span class="keyword">as</span> <span class="operator">the</span> auto-update <span class="built_in">value</span>, <span class="operator">or</span> both. It is <span class="operator">not</span> possible <span class="built_in">to</span> have <span class="operator">the</span> current timestamp be <span class="operator">the</span> default <span class="built_in">value</span> <span class="keyword">for</span> <span class="constant">one</span> column <span class="operator">and</span> <span class="operator">the</span> auto-update <span class="built_in">value</span> <span class="keyword">for</span> another column.</div></pre></td></tr></table></figure>

<p>看的仔细的同学就会发现，current timestamp as the default value for initializing the column，意思就是Mysql 会初始化第一个TIMESTAMP字段的default值为‘current timestamp’。一个表里面多个TIMESTAMP column 只能拥有一个‘current timestamp’值。</p>
<p>so，这下豁然开朗,既然如此，那么就开始测试以上理论吧。</p>
<ul>
<li><strong>既然第一个timestamp字段的默认default为‘current timestamp’,那我显示更改默认值总可以吧</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">create</span> <span class="keyword">table</span> lc_test_1(</span></div><div class="line">	<span class="string">`update_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">default</span> <span class="string">'0000-00-00'</span>,</div><div class="line">    <span class="string">`upload_time`</span> <span class="keyword">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> COMMENT <span class="string">'上传时间'</span></div><div class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 COMMENT=<span class="string">'已推送客户列表'</span>;</div><div class="line">Query OK, 0 rows affected  (0.10 sec)</div></pre></td></tr></table></figure>

<ul>
<li><strong>第一个timestamp字段的默认default为‘current timestamp’，第二个字段总不会了吧</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">root:test&gt; create table lc<span class="emphasis">_test_</span>4(</div><div class="line"><span class="code">      `update_time` timestamp NOT NULL ,</span></div><div class="line"><span class="code">      `upload_time` timestamp NOT NULL</span></div><div class="line"><span class="code">     )ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='已推送客户列表';</span></div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line"><span class="header">root:test&gt; desc lc_test_4;</span></div><div class="line">+-------------+-----------+------+-----+---------------------+-----------------------------+</div><div class="line"><span class="header">| Field       | Type      | Null | Key | Default             | Extra                       |</span></div><div class="line">+-------------+-----------+------+-----+---------------------+-----------------------------+</div><div class="line">| update<span class="emphasis">_time | timestamp | NO   |     | CURRENT_</span>TIMESTAMP   | on update CURRENT<span class="emphasis">_TIMESTAMP |</span></div><div class="line">| upload_time | timestamp | NO   |     | 0000-00-00 00:00:00 |                             |</div><div class="line"><span class="code">+-------------+</span>-----------<span class="code">+------+</span>-----<span class="code">+---------------------+</span>-----------------------------+</div><div class="line">2 rows in set (0.01 sec)</div></pre></td></tr></table></figure>

<p>ok，到这里，我想这个问题应该彻底明白了吧。</p>
<p>那我们又回过头来思考一下，为什么只能拥有一个CURRENT_TIMESTAMP default值呢？说实话，我还真没想明白。但是，我知道Mysql 5.5 高版本和Mysql5.6 以及更高版本以及去掉了这个限制</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Previously, <span class="keyword">at</span> most <span class="constant">one</span> TIMESTAMP column per table could be automatically initialized <span class="operator">or</span> updated <span class="built_in">to</span> <span class="operator">the</span> current <span class="built_in">date</span> <span class="operator">and</span> <span class="built_in">time</span>. This restriction has been lifted. Any TIMESTAMP column definition can have <span class="keyword">any</span> combination <span class="operator">of</span> DEFAULT CURRENT_TIMESTAMP <span class="operator">and</span> ON UPDATE CURRENT_TIMESTAMP clauses. In addition, these clauses now can be used <span class="operator">with</span> DATETIME column definitions. For more information, see Automatic Initialization <span class="operator">and</span> Updating <span class="keyword">for</span> TIMESTAMP <span class="operator">and</span> DATETIME.</div></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="subst">*</span> Mysql <span class="number">5.6</span> <span class="subst">*</span></div><div class="line"></div><div class="line">dbadmin:test<span class="subst">&gt;</span> create table lc_test_1(</div><div class="line">     <span class="string">`update_time`</span> timestamp <span class="literal">NOT</span> <span class="built_in">NULL</span>,</div><div class="line">     <span class="string">`upload_time`</span> timestamp <span class="literal">NOT</span> <span class="built_in">NULL</span> DEFAULT CURRENT_TIMESTAMP <span class="keyword">ON</span> UPDATE CURRENT_TIMESTAMP COMMENT <span class="string">'上传时间'</span></div><div class="line">     )ENGINE<span class="subst">=</span>InnoDB DEFAULT CHARSET<span class="subst">=</span>utf8 COMMENT<span class="subst">=</span><span class="string">'已推送客户列表'</span>;</div><div class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</div><div class="line"></div><div class="line">dbadmin:test<span class="subst">&gt;</span> create table lc_test_2(</div><div class="line">        <span class="string">`upload_time`</span> timestamp <span class="literal">NOT</span> <span class="built_in">NULL</span> DEFAULT CURRENT_TIMESTAMP <span class="keyword">ON</span> UPDATE CURRENT_TIMESTAMP COMMENT <span class="string">'上传时间'</span>,</div><div class="line">     <span class="string">`update_time`</span> timestamp <span class="literal">NOT</span> <span class="built_in">NULL</span></div><div class="line">    )ENGINE<span class="subst">=</span>InnoDB DEFAULT CHARSET<span class="subst">=</span>utf8 COMMENT<span class="subst">=</span><span class="string">'已推送客户列表'</span>;</div><div class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.02</span> sec)</div></pre></td></tr></table></figure>

<h2 id="结论">结论</h2>
<hr>
<ul>
<li><p>以上问题，均源于对Mysql 官方文档的不细致学习造成。</p>
</li>
<li><p>Mysql官方文档目前虽然讲解的原理不是很深，很细，但是确实值得我们仔细阅读。</p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/Keithlan/Keithlan.github.io/2015/07/14/mysql_error_1293/" data-id="z3iewuouo64qlisk" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>





  
    <article id="post-mysql_ulimit" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/14/mysql_ulimit/" class="article-date">
  <time datetime="2015-07-14T11:30:10.000Z" itemprop="datePublished">Jul 14 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ulimit_和_mysql_的故事">ulimit 和 mysql 的故事</h1>
<hr>
<h2 id="背景">背景</h2>
<p>&gt;<br>前些天，mysql 自带的监控脚本无故卡死，报错信息如下： Resource temporarily unavailable<br>然后将mysql 用户下的 ulimit 设置为8192 ， 则正常。<br>虽然暂时解决了问题，但是背后的原理还没弄清楚，这里打算详细了解一下。</p>
<h2 id="ulimit_-u_&amp;_ulimit_-n_区别？">ulimit -u &amp; ulimit -n 区别？</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">这里先弄清楚一个概念：</div><div class="line"></div><div class="line"><span class="keyword">open</span> <span class="keyword">files</span>                      (-<span class="keyword">n</span>) <span class="number">40000</span> ： 最大文件打开数</div><div class="line"></div><div class="line"><span class="built_in">max</span> user processes              (-<span class="keyword">u</span>) <span class="number">8092</span> ：  最大用户进程数</div></pre></td></tr></table></figure>

<h2 id="如何有效的设置ulimit_-u_？">如何有效的设置ulimit -u ？</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">这里有一篇淘宝褚霸的blog, 请参考：http://blog.yufeng.info/archives/<span class="number">2568</span></div><div class="line"></div><div class="line">简单总结：</div><div class="line"></div><div class="line">ulimit -u</div><div class="line"></div><div class="line"><span class="number">1</span>）先读取/etc/security/limits.conf，如果有/etc/security/limits.d/<span class="number">90</span>-nproc.conf存在，会覆盖掉/etc/security/limits.conf 的设置（<span class="type">RHEL6</span>）。 如果没有，则使用limits.conf（<span class="type">RHEL5</span>）。</div><div class="line"></div><div class="line"><span class="number">2</span>）如果注释掉/etc/security/limits.d/<span class="number">90</span>-nproc.conf 里面的内容，那么ulimit -u 的值由内核决定：</div><div class="line"></div><div class="line">$ cat /<span class="keyword">proc</span>/meminfo |grep <span class="type">MemTotal</span></div><div class="line"><span class="type">MemTotal</span>:       <span class="number">65858988</span> kB</div><div class="line">$ echo <span class="string">"65858988 / 128"</span>| bc </div><div class="line"><span class="number">514523</span></div><div class="line">$ ulimit -u</div><div class="line"><span class="number">514523</span></div></pre></td></tr></table></figure>

<h2 id="如何有效的设置ulimit_-n">如何有效的设置ulimit -n</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>） 直接修改/etc/security/limits.<span class="keyword">conf</span> ， 只能修改非root用户</div><div class="line"><span class="number">2</span>） 对于root用户，可以在/etc/<span class="keyword">profile</span> 中设置ulimit -HSn <span class="number">65535</span></div></pre></td></tr></table></figure>

<h2 id="mysqld_safe_的相关知识">mysqld_safe 的相关知识</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">在root用户下，虽然这样启动mysq：</span> <span class="comment">mysqld_safe</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">user=mysql</span> <span class="comment">&</span> <span class="comment">，</span> <span class="comment">mysqld</span> <span class="comment">虽然是用mysql用户启动的，但是它使用的环境变量如（ulimit</span> <span class="literal">-</span><span class="comment">u</span> <span class="comment">&</span> <span class="comment">ulimit</span> <span class="literal">-</span><span class="comment">n</span> <span class="comment">）都是root下的。</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">谨记</span></div></pre></td></tr></table></figure>

<h2 id="ulimit_-u_和_mysql的纠缠">ulimit -u  和 mysql的纠缠</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">既然知道了ulimit -u 是设置的mysql的最大进程数，那我们就来测试一把。</div><div class="line"></div><div class="line">先考虑一个问题： mysql是单进程多线程，那么为啥会超过max值呢？</div><div class="line"></div><div class="line">不管，先测。。。</div><div class="line"></div><div class="line">[root<span class="variable">@db10</span>-091 ~]<span class="comment"># cat /etc/security/limits.d/90-nproc.conf</span></div><div class="line">mysql       soft    nproc     <span class="number">40</span></div><div class="line"></div><div class="line">[mysql<span class="variable">@db10</span>-091 ~]$ ulimit -u</div><div class="line"><span class="number">40</span></div><div class="line"></div><div class="line">[root<span class="variable">@db10</span>-091 ~]<span class="comment"># lsof -u mysql | grep pipe | wc -l</span></div><div class="line"><span class="number">2</span></div><div class="line"></div><div class="line">循环<span class="number">40</span>次后：</div><div class="line">	mysql -ubackup -pbackup -e <span class="string">'select 1,sleep(60)'</span></div><div class="line">	</div><div class="line">[root<span class="variable">@db10</span>-091 ~]<span class="comment"># lsof -u mysql | grep pipe | wc -l</span></div><div class="line"><span class="number">72</span></div><div class="line"></div><div class="line">报错：</div><div class="line">	-bash: <span class="keyword">fork</span>: retry: Resource temporarily unavailable</div><div class="line">	-bash: <span class="keyword">fork</span>: retry: Resource temporarily unavailable</div><div class="line">	-bash: <span class="keyword">fork</span>: retry: Resource temporarily unavailable</div><div class="line">	</div><div class="line">所以，mysql的链接数会占用mysql的nproc，当超过max值后，会导致以上错误。</div></pre></td></tr></table></figure>

<h2 id="ulimit_-n_和_mysql的纠缠">ulimit -n  和 mysql的纠缠</h2>
<hr>
<ul>
<li><strong>innodb_open_files &amp; open_files_limit</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">解释来自官方文档：</div><div class="line"></div><div class="line"><span class="number">1</span>) innodb_open_files:</div><div class="line">It specifies <span class="operator">the</span> maximum <span class="built_in">number</span> <span class="operator">of</span> .ibd <span class="built_in">files</span> that MySQL can keep <span class="built_in">open</span> <span class="keyword">at</span> <span class="constant">one</span> <span class="built_in">time</span></div><div class="line"></div><div class="line">表示mysql能够同时打开的innoDB的表的数量。</div><div class="line"></div><div class="line"><span class="number">2</span>）open_files_limit</div><div class="line">Changes <span class="operator">the</span> <span class="built_in">number</span> <span class="operator">of</span> <span class="built_in">file</span> descriptors available <span class="built_in">to</span> mysqld.</div><div class="line"></div><div class="line">mysql 能够打开的文件描述符数量。</div><div class="line"></div><div class="line">PS： 一个表，不一定只打开一个文件描述符。计算方法请参照官方文档。</div><div class="line"></div><div class="line">问题：如果超过了innodb_open_files的大小会怎么样？</div><div class="line">答： mysql会将之前的表关闭，然后重启开启新的表。</div><div class="line"></div><div class="line">问题：如果超过了open_files_limit的大小会怎么样？</div><div class="line">答： 报错。 too many <span class="built_in">files</span> 等</div></pre></td></tr></table></figure>

<h2 id="如何有效的设置open_files_limit">如何有效的设置open_files_limit</h2>
<p>以下测试的前提条件是 : RHEL6.4, mysql 5.6.16 , 以root用户启动mysqld_safe . —至于区别，之前已经提到过。</p>
<p>至于以mysql用户启动mysqld_safe ， 请自行测试。</p>
<ul>
<li><strong>mysql配置文件中设置了open_files_limit</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">cat /etc/my.cnf | grep limit</div><div class="line">open-files-limit = 3000</div><div class="line"></div><div class="line">[root@db10-091 ~]# ulimit -n</div><div class="line">40000</div><div class="line"></div><div class="line"></div><div class="line">场景一：</div><div class="line"><span class="header">dbadmin:(none)&gt; show global variables like '%max_connections%';</span></div><div class="line">+-----------------+-------+</div><div class="line"><span class="header">| Variable_name   | Value |</span></div><div class="line">+-----------------+-------+</div><div class="line"><span class="header">| max_connections | 1000  |</span></div><div class="line">+-----------------+-------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"><span class="header">dbadmin:(none)&gt; show global variables like '%open_files_limit%';</span></div><div class="line">+------------------+-------+</div><div class="line"><span class="header">| Variable_name    | Value |</span></div><div class="line">+------------------+-------+</div><div class="line"><span class="header">| open_files_limit | 5000  |</span></div><div class="line">+------------------+-------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">场景二：</div><div class="line"><span class="header">dbadmin:(none)&gt; show global variables like '%max_conn%';</span></div><div class="line">+--------------------+-------+</div><div class="line"><span class="header">| Variable_name      | Value |</span></div><div class="line">+--------------------+-------+</div><div class="line"><span class="header">| max_connections    | 100   |</span></div><div class="line">+--------------------+-------+</div><div class="line">1 rows in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line"><span class="header">dbadmin:(none)&gt; show global variables like '%open_files_limit%';</span></div><div class="line">+------------------+-------+</div><div class="line"><span class="header">| Variable_name    | Value |</span></div><div class="line">+------------------+-------+</div><div class="line"><span class="header">| open_files_limit | 3000  |</span></div><div class="line">+------------------+-------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line">结果是：   open<span class="emphasis">_files_</span>limit = 5000.</div><div class="line">计算方式： 当open<span class="emphasis">_file_</span>limit被配置的时候，比较open<span class="emphasis">_files_</span>limit和max<span class="emphasis">_connections*5的值，哪个大用哪个</span></div></pre></td></tr></table></figure>

<ul>
<li><strong>mysql配置文件没有设置open_files_limit</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">cat /etc/my.cnf | grep limit  --没有设置open<span class="emphasis">_files_</span>limit</div><div class="line"># open-files-limit = 3000</div><div class="line"></div><div class="line">[root@db10-091 ~]# ulimit -n  --为什么看root用户的ulimit，之前已经讲过原因。</div><div class="line">40000</div><div class="line"></div><div class="line">场景一：</div><div class="line"></div><div class="line"><span class="header">dbadmin:(none)&gt; show global variables like '%max_conn%';</span></div><div class="line">+--------------------+-------+</div><div class="line"><span class="header">| Variable_name      | Value |</span></div><div class="line">+--------------------+-------+</div><div class="line"><span class="header">| max_connections    | 100   |</span></div><div class="line">+--------------------+-------+</div><div class="line">1 rows in set (0.01 sec)</div><div class="line"></div><div class="line"><span class="header">dbadmin:(none)&gt; show global variables like '%open_files_limit%';</span></div><div class="line">+------------------+-------+</div><div class="line"><span class="header">| Variable_name    | Value |</span></div><div class="line">+------------------+-------+</div><div class="line"><span class="header">| open_files_limit | 40000 |</span></div><div class="line">+------------------+-------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line">场景二：</div><div class="line"><span class="header">dbadmin:(none)&gt; show global variables like '%max_connection%';</span></div><div class="line">+-----------------+-------+</div><div class="line"><span class="header">| Variable_name   | Value |</span></div><div class="line">+-----------------+-------+</div><div class="line"><span class="header">| max_connections | 10000 |</span></div><div class="line">+-----------------+-------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"><span class="header">dbadmin:(none)&gt; show global variables like '%open_files_limit%';</span></div><div class="line">+------------------+-------+</div><div class="line"><span class="header">| Variable_name    | Value |</span></div><div class="line">+------------------+-------+</div><div class="line"><span class="header">| open_files_limit | 50000 |</span></div><div class="line">+------------------+-------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line">结果是：   open<span class="emphasis">_files_</span>limit=50000</div><div class="line">计算方式： 当open<span class="emphasis">_files_</span>limit没有被配置的时候，比较max<span class="emphasis">_connections*5和ulimit -n的值，哪个大用哪个</span></div></pre></td></tr></table></figure>



      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/Keithlan/Keithlan.github.io/2015/07/14/mysql_ulimit/" data-id="6x3glojv266mdnob" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>





  
    <article id="post-mysql_replicate_rule" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/14/mysql_replicate_rule/" class="article-date">
  <time datetime="2015-07-14T11:30:10.000Z" itemprop="datePublished">Jul 14 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Mysql_复制过滤详解">Mysql 复制过滤详解</h1>
<hr>
<h2 id="背景">背景</h2>
<p>如果有这样的一个需求：master 有3个库A，B，C ，D，由于某种原因，现在需要将其中2个库B，C单独拆分出来，单独一个实例。 如果是你，打算怎么做呢？  常见的做法就是，单独搭建一个只有B，C库的实例，然后只复制master的B，C库，过滤掉A，D库。那么复制过滤就应运而生了，replicate-*-do-DB/table 等。</p>
<h2 id="理由">理由</h2>
<p>为了搭建这一套环境（只复制master的B，C库），部分人会在my.cnf中这样配置：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">-replicate-<span class="keyword">do</span>-db=<span class="constant">B</span>,<span class="constant">C</span></span></div></pre></td></tr></table></figure>


<p>当然，按照大家的惯性思维，认为这样是没有错的。不幸的是，灾难已经来临。</p>
<p>官方文档：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Warning</div><div class="line">To specify multiple databases you must <span class="operator"><span class="keyword">use</span> multiple instances <span class="keyword">of</span> this <span class="keyword">option</span>. Because <span class="keyword">database</span> <span class="keyword">names</span> can contain commas, <span class="keyword">if</span> you supply a comma separated list <span class="keyword">then</span> the list will be treated <span class="keyword">as</span> the name <span class="keyword">of</span> a single <span class="keyword">database</span>.</span></div></pre></td></tr></table></figure>

<p>mysql 会认为<code>B,C</code> 为一个库名，而不是2个库。</p>
<p>然而，这里不仅仅有一个复制过滤参数，一共包括：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">-<span class="ruby">-replicate-<span class="keyword">do</span>-db </span></div><div class="line">-<span class="ruby">-replicate-ignore-db</span></div><div class="line">-<span class="ruby">-replicate-<span class="keyword">do</span>-table</span></div><div class="line">-<span class="ruby">-replicate-wild-<span class="keyword">do</span>-table</span></div><div class="line">-<span class="ruby">-replicate-ignore-table</span></div><div class="line">-<span class="ruby">-replicate-wild-ignore-table</span></div></pre></td></tr></table></figure>

<p>这里面可以随意组合，且不同组合有不同的含义，为了彻底搞清楚他们直接的关系，下面我们一起来一窥究竟。</p>
<h2 id="Database-Level_Replication_流程图">Database-Level Replication 流程图</h2>
<hr>
<p><img src="image/rpl_db_level.png" alt="db" title="db"></p>
<h2 id="Table-Level_Replication_流程图">Table-Level Replication 流程图</h2>
<hr>
<p><img src="image/rpl_tb_level.png" alt="tb" title="tb"></p>
<h2 id="相关要点">相关要点</h2>
<hr>
<ul>
<li><p><strong>在DB level 中，当binlog-format=statement 时，过滤以use DB为主（不允许跨库）。为rows模式是：不以use DB为主（允许跨库）</strong></p>
</li>
<li><p><strong>不管binlog格式是statement，还是rows模式，table level的判断都是 不以use DB为主（可以跨库的）</strong></p>
</li>
<li><p><strong>总的流程走向：先判断DB-level，如果DB-level 判断完成后需要exit，则退出。如果DB-level判断完成后，没有exit，则再判断Table-level</strong></p>
</li>
<li><p><strong>在DB-level中，如果有replicate-do-db，则判断replicate-do-db，将不会走到replicate-ignore-db这层。 如果判断replicate-do-db符合条件，则判断table-level。 如果不符合，则exit</strong></p>
</li>
<li><p><strong>在DB-level中，如果没有replicate-do-db，但是有replicate-ignore-db。 流程则是：符合replicate-ignore-db规则，则exit，不符合，则走到table-level层继续判断</strong></p>
</li>
<li><p><strong>在Table-level中，判断逻辑顺序自上而下为：replicate-do-table -&gt;  replicate-ignore-table -&gt; replicate-wild-do-table -&gt; replicate-wild-ignore-table </strong></p>
</li>
<li><p><strong>在Table-level中, 从第一个阶段（replicate-do-table）开始，如果符合replicate-do-table判断规则，则exit。如果不符合，则跳到下一层（replicate-ignore-table）。 然后以此内推，直到最后一层（replicate-wild-ignore-table）都不符合，则最后判断是否有（replicate-do-table or replicate-wild-do-table），如果有，则ignore &amp; exit。如果没有，则execute &amp; exit</strong></p>
</li>
</ul>
<h2 id="测试">测试</h2>
<hr>
<p>说明：以下测试，均以statement格式为例。 rows模式参见原理同样可以证明，这里就不解释。</p>
<ul>
<li><strong>第一种情况：设置replicate_do_DB=A,B</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> </div><div class="line">结论：<span class="literal">A</span>和B都没有在slave上执行。因为mysql将'<span class="literal">A</span>,B'作为一个库名。</div></pre></td></tr></table></figure>

<ul>
<li><strong>第二种情况</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">replicate_do_DB=user_prop_s00_db </div><div class="line">replicate_do_DB=heartbeat_db</div><div class="line">replicate-ignore-db=mysql</div><div class="line">replicate-ignore-db=test</div><div class="line"></div><div class="line">replicate_wild_do_tables=user_prop_s00_db.%</div><div class="line">replicate-wild-ignore-table=mysql.%</div><div class="line">replicate-wild-ignore-table=test.%</div><div class="line"></div><div class="line">结论：</div><div class="line"><span class="operator"><span class="keyword">use</span> user_prop_s00_db;</span> dml； <span class="comment">--来自user_prop_s00_db库的操作都复制。</span></div><div class="line"><span class="operator"><span class="keyword">use</span> heartbeat_db;</span> dml ;    <span class="comment">--来自其他库的所有表都不复制</span></div><div class="line"></div><div class="line">过程分析：如果存在DB-level规则，则不允许跨库操作。以上有<span class="operator"><span class="keyword">do</span>规则在，就走<span class="keyword">do</span>规则且忽略<span class="keyword">ignore</span>规则。很明显，满足user_prop_s00_db & heartbeat_db DB-<span class="keyword">level</span>的操作都可以进入<span class="keyword">table</span>-<span class="keyword">level</span>。</span></div><div class="line">so： </div><div class="line"><span class="number">1</span>） <span class="keyword">use</span> user_prop_s00_db; dml； 满足wild_do_tables的过滤，允许操作。</div><div class="line">2） <span class="operator"><span class="keyword">use</span> heartbeat_db;</span> dml ;  不满足任何一个table-level的规则，所以走到最后一层分析（存在wild_do_tables or _do_tables，则ignore & exit）</div></pre></td></tr></table></figure>

<ul>
<li><strong>第三种情况</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">replicate_do_DB=user_prop_s00_db</div><div class="line">replicate_do_DB=heartbeat_db</div><div class="line">replicate-ignore-db=mysql</div><div class="line">replicate-ignore-db=test</div><div class="line"></div><div class="line">replicate_wild_do_tables=user_prop_s00_db.%</div><div class="line">replicate_wild_do_tables=heartbeat_db.%</div><div class="line">replicate-wild-ignore-table=mysql.%</div><div class="line">replicate-wild-ignore-table=test.%</div><div class="line"></div><div class="line">结果：</div><div class="line"></div><div class="line">1)跨库操作user_prop_s00_db,heartbeat_db没有通过。比如：<span class="operator"><span class="keyword">use</span> hehe;</span> <span class="operator"><span class="keyword">insert</span> <span class="keyword">into</span> heartbeat_db.table_1 <span class="keyword">values</span>(<span class="number">1</span>);</span> #slave 不执行。</div><div class="line"></div><div class="line">2)跨库操作user_prop_s00_db,heartbeat_db通过. 比如：<span class="operator"><span class="keyword">use</span> user_prop_s00_db;</span> <span class="operator"><span class="keyword">insert</span> <span class="keyword">into</span> heartbeat_db.table_1 <span class="keyword">values</span>(<span class="number">1</span>);</span> #slave 执行成功。</div><div class="line"></div><div class="line">为什么 例2）中的跨库可以成功呢？</div><div class="line">理由很简单：虽然是跨库，但是这两个库在DB-level中都是被允许的。</div></pre></td></tr></table></figure>

<ul>
<li><strong>第四种情况</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">只设置replicate_<span class="keyword">do</span>_DB=A</div><div class="line">replicate_<span class="keyword">do</span>_DB=B</div><div class="line"></div><div class="line">结果：A，B以外的跨库操作不会通过。</div><div class="line">理由：自己可以根据原理试试</div></pre></td></tr></table></figure>

<ul>
<li><strong>第五种情况</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">只设置</div><div class="line">replicate_wild_<span class="keyword">do</span>_tables=A.%</div><div class="line">replicate_wild_<span class="keyword">do</span>_tables=B.%</div><div class="line">结果： A，B以外的跨库操作，也可以通过</div><div class="line">理由：自己可以根据原理试试</div></pre></td></tr></table></figure>

<h2 id="最后">最后</h2>
<hr>
<p>以上情况，还可以衍生出各种场景和组合，只要弄懂了原理，基本都没有问题。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/Keithlan/Keithlan.github.io/2015/07/14/mysql_replicate_rule/" data-id="od2vrseulhusa873" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>





  
    <article id="post-mysql_recovery_myisam_slave" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/14/mysql_recovery_myisam_slave/" class="article-date">
  <time datetime="2015-07-14T11:30:10.000Z" itemprop="datePublished">Jul 14 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="特殊场景下的slave重构">特殊场景下的slave重构</h1>
<blockquote>
<p>It is important to back up your databases so that you can recover your data and be up and running again in case problems occur, such as system crashes, hardware failures, or users deleting data by mistake. Backups are also essential as a safeguard before upgrading a MySQL installation, and they can be used to transfer a MySQL installation to another system or to set up replication slave servers.</p>
</blockquote>
<p><a href="http://dev.mysql.com/doc/refman/5.6/en/backup-and-recovery.html" target="_blank" rel="external">Mysql Backup and Recovery</a></p>
<h2 id="背景说明">背景说明</h2>
<hr>
<p>备份和恢复，这是一个非常大的话题，但这不是本章的重点，关于详情，请看之前分享过的一篇PDF <a href="https://github.com/Keithlan/Keithlan.github.io/tree/master/github_md/Mysql/BACKUP_RECOVERY" target="_blank" rel="external">Mysql Backup and Recovery 分享</a> 。 备份，主要是用于灾难恢复。 那么，今天我们就来讨论一下再没有备份的前提下，如果从master上恢复一台slave出来？</p>
<h2 id="前提">前提</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">* Master</div><div class="line">	1. Myisam 引擎</div><div class="line">	2. 无全量备份</div><div class="line">	3. 有最近2天的binlog</div><div class="line">	4. SQL语句特点： 全是insert</div><div class="line">	5. 每个表都有主键id，并且auto increment </div><div class="line">* Master 上的table</div><div class="line">	1. table1_YYYMM (按月分表)</div><div class="line">	2. table2_YYYMMDD (按天分表)</div><div class="line">	3. table3 (整张表)</div></pre></td></tr></table></figure>

<p>如果是innoDB 引擎，到时可以用mysqldump —single transaction 或者 percona xtrabackup 来恢复。  但是在Myisam中，在这种场景下，如何恢复搭建slave呢？</p>
<h2 id="方案一">方案一</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1. copy 已经不在写的表，比如table1_YYYMM 今天之前，今月之前的表。 消耗时间A</div><div class="line">2. 在master 上<span class="operator"><span class="keyword">flush</span> <span class="keyword">tables</span> <span class="keyword">with</span> <span class="keyword">read</span> <span class="keyword">lock</span>；<span class="keyword">show</span> <span class="keyword">master</span> <span class="keyword">status</span>；消耗时间B</span></div><div class="line"><span class="number">3.</span> copy 剩下的表； 消耗时间C</div><div class="line"><span class="number">4.</span> <span class="keyword">unlock</span> <span class="keyword">tables</span>；</div><div class="line"><span class="number">5.</span> 在<span class="keyword">slave</span>上，开启同步</div></pre></td></tr></table></figure>

<ul>
<li><strong>方案一的优点和缺点也很明显：</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">*</span>优点</div><div class="line">	1.无须担心一致性问题。</div><div class="line"><span class="keyword">*</span>缺点</div><div class="line">	1. 需要锁表，锁住的时间就是copy数据的时间C。 表越大，锁越长，有些业务是不允许这么长时间的。</div></pre></td></tr></table></figure>

<h2 id="方案二">方案二</h2>
<p>这里主要抓住一点，只有insert操作。根据这个特性，我们可以针对性的恢复</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">* 检查一下表的自增主键</div><div class="line">* 第一步：提前先copy好所有不再写的表，比如table1_YYYMM 今天之前，今月之前的表，同上。  消耗时间A</div><div class="line">* 第二步：然后再copy 当天，当月，当时的表， 并且记下 max（主键），一遍后续补数据用。  消耗时间B</div><div class="line">* 第三步：在master上  消耗时间C</div><div class="line"> 	1. <span class="operator"><span class="keyword">flush</span> <span class="keyword">tables</span> <span class="keyword">with</span> <span class="keyword">read</span> <span class="keyword">lock</span>；</span></div><div class="line"> 	<span class="number">2.</span> <span class="keyword">show</span> <span class="keyword">master</span> <span class="keyword">status</span>； </div><div class="line"> 	<span class="number">3.</span> 记下当天，当月，当时的表的<span class="keyword">max</span>（主键），由于是myisam引擎，基本是瞬间完成。 </div><div class="line"> 	<span class="number">4.</span> <span class="keyword">unlock</span> <span class="keyword">tables</span>； </div><div class="line">* 第四步：修补第二步和第三步 <span class="keyword">max</span>（主键）中的空洞。  </div><div class="line">* 第五步：<span class="keyword">repair</span> 部分表，可以用同步机制自动检测且修复，无须人为关心。</div><div class="line">* 第六步：在<span class="keyword">slave</span>上，开启同步</div></pre></td></tr></table></figure>

<ul>
<li><strong>方案二的优点和缺点：</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">* 优点：</div><div class="line">	1. 基本上无中断业务时间。</div><div class="line">	2. 不会丢失任何数据。</div><div class="line">* 缺点：</div><div class="line">	1. 需要脚本处理max值，记录position点。</div><div class="line">	2. 需要repair表。</div><div class="line">	3. 如果有update，delete语句，有风险。</div></pre></td></tr></table></figure>

<p>以上，就是这次奇葩的数据恢复。</p>
<h2 id="总结">总结</h2>
<ol>
<li>没有备份，等于自掘坟墓。</li>
<li>没有测试恢复过的备份，等于没有备份。</li>
<li>请看第一点。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/Keithlan/Keithlan.github.io/2015/07/14/mysql_recovery_myisam_slave/" data-id="8a34hqvrmjw5wrsw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>





  
    <article id="post-mysql_in" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/14/mysql_in/" class="article-date">
  <time datetime="2015-07-14T11:30:10.000Z" itemprop="datePublished">Jul 14 2015</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="MySQL_5-6_中_In_优化的那些事">MySQL 5.6 中 In 优化的那些事</h1>
<hr>
<h2 id="背景">背景</h2>
<p>这里不准备讲 In 和 Or 的效率和区别。也不会讲 In 和 exist 的效率和区别。只是纯聊 Mysql 中常常会出现的 where xx in （）; 在实际工作中，这种用法很常见，然后再最近一段时间在优化slow query的时候，发现某些有In的查询基本上都rows exam了全表，这又是为什么呢？</p>
<h2 id="案例一，_组合条件">案例一， 组合条件</h2>
<hr>
<ul>
<li><strong>表结构</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">| ajk_market_analysis_20150212 | <span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`ajk_market_analysis_20150212`</span> (</span></div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`daydate`</span> <span class="built_in">date</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> COMMENT <span class="string">'日期格式2013-10-11'</span>,</div><div class="line">  <span class="string">`cityId`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'城市id'</span>,</div><div class="line">  <span class="string">`blockId`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'板块areacode'</span>,</div><div class="line">  <span class="string">`commId`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'小区id'</span>,</div><div class="line">  <span class="string">`priceRank`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'价格段'</span>,</div><div class="line">  <span class="string">`averageVPPV`</span> <span class="built_in">float</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'昨日房均有效VPPV'</span>,</div><div class="line">  <span class="string">`marketScore`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'市场分'</span>,</div><div class="line">  <span class="string">`scoreRank`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'市场分的段,值-1,2,3 3最好'</span>,</div><div class="line">  <span class="string">`type`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'1-定价 2竞价'</span>,</div><div class="line">  <span class="string">`totalVPPV`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'总有效VPPV'</span>,</div><div class="line">  <span class="string">`spreadPropNum`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'昨日推广房源总数'</span>,</div><div class="line">  <span class="string">`isY`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'总房源量是否大于Y'</span>,</div><div class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="string">`id`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`c_b_t_s_m`</span> (<span class="string">`blockId`</span>,<span class="string">`cityId`</span>,<span class="string">`type`</span>,<span class="string">`scoreRank`</span>,<span class="string">`marketScore`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`idx1`</span> (<span class="string">`cityId`</span>,<span class="string">`commId`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`c_t_s_i_c`</span> (<span class="string">`cityId`</span>,<span class="string">`type`</span>,<span class="string">`scoreRank`</span>,<span class="string">`isY`</span>,<span class="string">`commId`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">292829</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8  |</div><div class="line"></div><div class="line"></div><div class="line">*************************** <span class="number">1.</span> <span class="keyword">row</span> ***************************</div><div class="line">           Name: ajk_market_analysis_20150212</div><div class="line">         <span class="keyword">Engine</span>: <span class="keyword">InnoDB</span></div><div class="line">        <span class="keyword">Version</span>: <span class="number">10</span></div><div class="line">     Row_format: Compact</div><div class="line">           <span class="keyword">Rows</span>: <span class="number">291417</span></div><div class="line"> Avg_row_length: <span class="number">88</span></div><div class="line">    Data_length: <span class="number">25739264</span></div><div class="line">Max_data_length: <span class="number">0</span></div><div class="line">   Index_length: <span class="number">53133312</span></div><div class="line">      Data_free: <span class="number">7340032</span></div><div class="line"> Auto_increment: <span class="number">292829</span></div><div class="line">    Create_time: <span class="number">2015</span>-<span class="number">01</span>-<span class="number">30</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">22</span></div><div class="line">    Update_time: <span class="literal">NULL</span></div><div class="line">     Check_time: <span class="literal">NULL</span></div><div class="line">      <span class="keyword">Collation</span>: utf8_general_ci</div><div class="line">       <span class="keyword">Checksum</span>: <span class="literal">NULL</span></div><div class="line"> Create_options:</div><div class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.08</span> sec)</div></pre></td></tr></table></figure>

<ul>
<li><strong>执行计划</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">dbadmin:ajk<span class="emphasis">_dw_</span>stats&gt; explain select  <span class="smartquote">`commId` , `spreadPropNum` , `totalVPPV` , `type`  from `ajk_market_analysis_20150212` where `cityId` = '</span>14'  and <span class="smartquote">`type` = '</span>0'  and <span class="smartquote">`scoreRank` in ( '</span>2' , <span class="emphasis">'3'</span> )  and <span class="smartquote">`isY` = '</span>1'  and <span class="smartquote">`commId` in ( '</span>76832' , <span class="emphasis">'76776'</span> , <span class="emphasis">'77562'</span> , <span class="emphasis">'80363'</span> , <span class="emphasis">'121238'</span> , <span class="emphasis">'182922'</span> , <span class="emphasis">'422947'</span> , <span class="emphasis">'51056'</span> , <span class="emphasis">'185557'</span> , <span class="emphasis">'81276'</span> , <span class="emphasis">'80530'</span> , <span class="emphasis">'80534'</span> , <span class="emphasis">'80217'</span> , <span class="emphasis">'76830'</span> , <span class="emphasis">'184396'</span> , <span class="emphasis">'505857'</span> , <span class="emphasis">'567958'</span> , <span class="emphasis">'78911'</span> , <span class="emphasis">'120264'</span> , <span class="emphasis">'122099'</span> , <span class="emphasis">'80401'</span> , <span class="emphasis">'299956'</span> , <span class="emphasis">'430371'</span> , <span class="emphasis">'308830'</span> , <span class="emphasis">'51235'</span> , <span class="emphasis">'81559'</span> , <span class="emphasis">'116149'</span> , <span class="emphasis">'84449'</span> , <span class="emphasis">'656162'</span> , <span class="emphasis">'502933'</span> , <span class="emphasis">'123895'</span> , <span class="emphasis">'50600'</span> , <span class="emphasis">'80535'</span> , <span class="emphasis">'122851'</span> , <span class="emphasis">'246270'</span> , <span class="emphasis">'299003'</span> , <span class="emphasis">'217889'</span> , <span class="emphasis">'186881'</span> , <span class="emphasis">'286019'</span> , <span class="emphasis">'77388'</span> )   #broker-mobiapi: V1<span class="emphasis">_Find_</span>NearbyCommController@HotComm.php (68) 1423704168;</div><div class="line"><span class="code">    -&gt;</span></div><div class="line"><span class="header">    -&gt; ;</span></div><div class="line">+----+-------------+------------------------------+------+----------------+------+---------+------+--------+-------------+</div><div class="line"><span class="header">| id | select_type | table                        | type | possible_keys  | key  | key_len | ref  | rows   | Extra       |</span></div><div class="line">+----+-------------+------------------------------+------+----------------+------+---------+------+--------+-------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | ajk_market_analysis_20150212 | ALL  | idx1,c_t_s_i_c | NULL | NULL    | NULL | 291417 | Using where |</span></div><div class="line">+----+-------------+------------------------------+------+----------------+------+---------+------+--------+-------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<h2 id="案例二，单一条件">案例二，单一条件</h2>
<hr>
<ul>
<li><strong>表结构</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">| solly_nh_comm_recomm_lookandlook | <span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`solly_nh_comm_recomm_lookandlook`</span> (</span></div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`comm_id`</span> <span class="built_in">int</span>(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'楼盘id'</span>,</div><div class="line">  <span class="string">`comm_id_tj`</span> <span class="built_in">int</span>(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'推荐楼盘id'</span>,</div><div class="line">  <span class="string">`city_id`</span> <span class="built_in">int</span>(<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'城市id'</span>,</div><div class="line">  <span class="string">`city_id_tj`</span> <span class="built_in">int</span>(<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'推荐城市id'</span>,</div><div class="line">  <span class="string">`tj_cishu`</span> <span class="built_in">int</span>(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'推荐次数'</span>,</div><div class="line">  <span class="string">`tj_rate_w`</span> <span class="built_in">decimal</span>(<span class="number">16</span>,<span class="number">12</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0.000000000000'</span> COMMENT <span class="string">'加权推荐次数'</span>,</div><div class="line">  <span class="string">`log_dt`</span> <span class="built_in">varchar</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span> COMMENT <span class="string">'日期'</span>,</div><div class="line">  <span class="string">`comm_rank`</span> <span class="built_in">int</span>(<span class="number">3</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span> COMMENT <span class="string">'排序'</span>,</div><div class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="string">`id`</span>),</div><div class="line">  <span class="keyword">KEY</span> <span class="string">`NewIndex1`</span> (<span class="string">`comm_id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">324992</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8                           |</div><div class="line"></div><div class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">dbadmin:ajk_dw_stats&gt; <span class="keyword">show</span> <span class="keyword">table</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'solly_nh_comm_recomm_lookandlook'</span>\G</div><div class="line">*************************** <span class="number">1.</span> <span class="keyword">row</span> ***************************</div><div class="line">           Name: solly_nh_comm_recomm_lookandlook</div><div class="line">         <span class="keyword">Engine</span>: <span class="keyword">InnoDB</span></div><div class="line">        <span class="keyword">Version</span>: <span class="number">10</span></div><div class="line">     Row_format: Compact</div><div class="line">           <span class="keyword">Rows</span>: <span class="number">323862</span></div><div class="line"> Avg_row_length: <span class="number">73</span></div><div class="line">    Data_length: <span class="number">23642112</span></div><div class="line">Max_data_length: <span class="number">0</span></div><div class="line">   Index_length: <span class="number">7880704</span></div><div class="line">      Data_free: <span class="number">6291456</span></div><div class="line"> Auto_increment: <span class="number">324992</span></div><div class="line">    Create_time: <span class="number">2014</span>-<span class="number">12</span>-<span class="number">02</span> <span class="number">15</span>:<span class="number">31</span>:<span class="number">36</span></div><div class="line">    Update_time: <span class="literal">NULL</span></div><div class="line">     Check_time: <span class="literal">NULL</span></div><div class="line">      <span class="keyword">Collation</span>: utf8_general_ci</div><div class="line">       <span class="keyword">Checksum</span>: <span class="literal">NULL</span></div><div class="line"> Create_options:</div><div class="line">        Comment:</div><div class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.07</span> sec)</div></pre></td></tr></table></figure>

<ul>
<li><strong>执行计划</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="header">dbadmin:ajk_dw_stats&gt; explain SELECT * FROM solly_nh_comm_recomm_lookandlook WHERE `comm_id` IN (228955,252368,228744,249444,237337,237869,236838,236834,250955,211207);</span></div><div class="line">+----+-------------+----------------------------------+------+---------------+------+---------+------+--------+-------------+</div><div class="line"><span class="header">| id | select_type | table                            | type | possible_keys | key  | key_len | ref  | rows   | Extra       |</span></div><div class="line">+----+-------------+----------------------------------+------+---------------+------+---------+------+--------+-------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | solly_nh_comm_recomm_lookandlook | ALL  | NewIndex1     | NULL | NULL    | NULL | 323862 | Using where |</span></div><div class="line">+----+-------------+----------------------------------+------+---------------+------+---------+------+--------+-------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<h2 id="分析">分析</h2>
<hr>
<p>以上两种案例，其实都是同一种情况，我们现在以第一个例子为案例进行分析</p>
<ul>
<li>有idx1 索引(<code>cityId</code>,<code>commId</code>) 为啥不用呢？ 我们将 commid in 中的列表变少，看看情况怎么样？</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">dbadmin:ajk<span class="emphasis">_dw_</span>stats&gt; explain select  <span class="smartquote">`commId` , `spreadPropNum` , `totalVPPV` , `type`  from `ajk_market_analysis_20150212` where `cityId` = '</span>14'  and <span class="smartquote">`type` = '</span>0'  and <span class="smartquote">`scoreRank` in ( '</span>2' , <span class="emphasis">'3'</span> )  and <span class="smartquote">`isY` = '</span>1'  and <span class="smartquote">`commId` in ( '</span>76832' , <span class="emphasis">'76776'</span> , <span class="emphasis">'77562'</span> , <span class="emphasis">'80363'</span> , <span class="emphasis">'121238'</span> , <span class="emphasis">'182922'</span> , <span class="emphasis">'422947'</span> , <span class="emphasis">'51056'</span> , <span class="emphasis">'1111'</span>)   #broker-mobiapi: V1<span class="emphasis">_Find_</span>NearbyCommController@HotComm.php (68) 1423704168;</div><div class="line"><span class="header">    -&gt; ;</span></div><div class="line">+----+-------------+------------------------------+-------+----------------+------+---------+------+------+------------------------------------+</div><div class="line"><span class="header">| id | select_type | table                        | type  | possible_keys  | key  | key_len | ref  | rows | Extra                              |</span></div><div class="line">+----+-------------+------------------------------+-------+----------------+------+---------+------+------+------------------------------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | ajk_market_analysis_20150212 | range | idx1,c_t_s_i_c | idx1 | 8       | NULL |   40 | Using index condition; Using where |</span></div><div class="line">+----+-------------+------------------------------+-------+----------------+------+---------+------+------+------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<p>不多不少，In 列表小于10 的时候，索引计划调整了。测试过in 后面10个列表的情况，还是很糟糕。</p>
<p>为啥刚好是10呢？ 搜索了一下mysql的参数,eq_range_index_dive_limit 刚好是10</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="header">dbadmin:ajk_dw_stats&gt; show global variables  like '%eq_%';</span></div><div class="line">+---------------------------+-------+</div><div class="line"><span class="header">| Variable_name             | Value |</span></div><div class="line">+---------------------------+-------+</div><div class="line"><span class="header">| eq_range_index_dive_limit | 10    |</span></div><div class="line">+---------------------------+-------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>

<p>那么eq_range_index_dive_limit 是用来干嘛的呢？这个参数之前有一篇分享有提过，可以参考<a href="http://gitlab.corp.anjuke.com/_dba/blog/blob/master/Keithlan/mysql/ERROR_HANDLE/mysql_group_order_limit.md" target="_blank" rel="external">Mysql5.6 执行计划出错</a></p>
<h2 id="解决方案">解决方案</h2>
<hr>
<ul>
<li><strong>解决方案一：将In控制在10以内</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">既然知道为啥了，我们是否可以有相应的措施,首先降低<span class="keyword">in</span>的数量，用union代替</div><div class="line"></div><div class="line">dbadmin:ajk_dw_stats<span class="subst">&gt;</span> explain <span class="keyword">select</span>  <span class="string">`commId`</span> , <span class="string">`spreadPropNum`</span> , <span class="string">`totalVPPV`</span> , <span class="string">`type`</span>  from <span class="string">`ajk_market_analysis_20150212`</span> <span class="keyword">where</span> <span class="string">`cityId`</span> <span class="subst">=</span> <span class="string">'14'</span>  <span class="literal">and</span> <span class="string">`type`</span> <span class="subst">=</span> <span class="string">'0'</span>  <span class="literal">and</span> <span class="string">`scoreRank`</span> <span class="keyword">in</span> ( <span class="string">'2'</span> , <span class="string">'3'</span> )  <span class="literal">and</span> <span class="string">`isY`</span> <span class="subst">=</span> <span class="string">'1'</span>  <span class="literal">and</span> <span class="string">`commId`</span> <span class="keyword">in</span> ( <span class="string">'76832'</span> , <span class="string">'76776'</span> , <span class="string">'77562'</span> , <span class="string">'80363'</span> , <span class="string">'121238'</span> , <span class="string">'182922'</span> , <span class="string">'422947'</span> , <span class="string">'51056'</span> , <span class="string">'185557'</span>) union <span class="keyword">select</span>  <span class="string">`commId`</span> , <span class="string">`spreadPropNum`</span> , <span class="string">`totalVPPV`</span> , <span class="string">`type`</span>  from <span class="string">`ajk_market_analysis_20150212`</span> <span class="keyword">where</span> <span class="string">`cityId`</span> <span class="subst">=</span> <span class="string">'14'</span>  <span class="literal">and</span> <span class="string">`type`</span> <span class="subst">=</span> <span class="string">'0'</span>  <span class="literal">and</span> <span class="string">`scoreRank`</span> <span class="keyword">in</span> ( <span class="string">'2'</span> , <span class="string">'3'</span> )  <span class="literal">and</span> <span class="string">`isY`</span> <span class="subst">=</span> <span class="string">'1'</span>  <span class="literal">and</span> <span class="string">`commId`</span> <span class="keyword">in</span> ( <span class="string">'50600'</span> , <span class="string">'80535'</span> , <span class="string">'122851'</span> , <span class="string">'246270'</span> , <span class="string">'299003'</span> , <span class="string">'217889'</span> , <span class="string">'186881'</span> , <span class="string">'286019'</span> , <span class="string">'77388'</span> );</div><div class="line"><span class="subst">+----+--------------+------------------------------+-------+----------------+------+---------+------+------+------------------------------------+</span></div><div class="line"><span class="subst">|</span> id <span class="subst">|</span> select_type  <span class="subst">|</span> table                        <span class="subst">|</span> <span class="keyword">type</span>  <span class="subst">|</span> possible_keys  <span class="subst">|</span> key  <span class="subst">|</span> key_len <span class="subst">|</span> ref  <span class="subst">|</span> <span class="keyword">rows</span> <span class="subst">|</span> Extra                              <span class="subst">|</span></div><div class="line"><span class="subst">+----+--------------+------------------------------+-------+----------------+------+---------+------+------+------------------------------------+</span></div><div class="line"><span class="subst">|</span>  <span class="number">1</span> <span class="subst">|</span> PRIMARY      <span class="subst">|</span> ajk_market_analysis_20150212 <span class="subst">|</span> range <span class="subst">|</span> idx1,c_t_s_i_c <span class="subst">|</span> idx1 <span class="subst">|</span> <span class="number">8</span>       <span class="subst">|</span> <span class="built_in">NULL</span> <span class="subst">|</span>   <span class="number">40</span> <span class="subst">|</span> Using index condition; Using <span class="keyword">where</span> <span class="subst">|</span></div><div class="line"><span class="subst">|</span>  <span class="number">2</span> <span class="subst">|</span> UNION        <span class="subst">|</span> ajk_market_analysis_20150212 <span class="subst">|</span> range <span class="subst">|</span> idx1,c_t_s_i_c <span class="subst">|</span> idx1 <span class="subst">|</span> <span class="number">8</span>       <span class="subst">|</span> <span class="built_in">NULL</span> <span class="subst">|</span>   <span class="number">31</span> <span class="subst">|</span> Using index condition; Using <span class="keyword">where</span> <span class="subst">|</span></div><div class="line"><span class="subst">|</span> <span class="built_in">NULL</span> <span class="subst">|</span> UNION RESULT <span class="subst">|</span> <span class="subst">&lt;</span>union1,<span class="number">2</span><span class="subst">&gt;</span>                   <span class="subst">|</span> <span class="literal">ALL</span>   <span class="subst">|</span> <span class="built_in">NULL</span>           <span class="subst">|</span> <span class="built_in">NULL</span> <span class="subst">|</span> <span class="built_in">NULL</span>    <span class="subst">|</span> <span class="built_in">NULL</span> <span class="subst">|</span> <span class="built_in">NULL</span> <span class="subst">|</span> Using temporary                    <span class="subst">|</span></div><div class="line"><span class="subst">+----+--------------+------------------------------+-------+----------------+------+---------+------+------+------------------------------------+</span></div><div class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>

<p>但是这种方式，是否是太愚蠢了呢？ 我们不可能每次都去控制这个长度。</p>
<ul>
<li><strong>解决方案二：rebuild 索引，可能解决</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">这种方式，我曾测试过，成功的概率<span class="number">10</span><span class="comment">%，所以不可取。</span></div></pre></td></tr></table></figure>

<ul>
<li><strong>解决方案三：设置eq_range_index_dive_limit=200，实际上Mysql5.7 已经默认为200</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">dbadmin:(none)&gt; set eq<span class="emphasis">_range_</span>index<span class="emphasis">_dive_</span>limit=200;</div><div class="line">Query OK, 0 rows affected (0.00 sec)</div><div class="line"></div><div class="line">dbadmin:ajk<span class="emphasis">_dw_</span>stats&gt; explain select  <span class="smartquote">`commId` , `spreadPropNum` , `totalVPPV` , `type`  from `ajk_market_analysis_20150212` where `cityId` = '</span>14'  and <span class="smartquote">`type` = '</span>0'  and <span class="smartquote">`scoreRank` in ( '</span>2' , <span class="emphasis">'3'</span> )  and <span class="smartquote">`isY` = '</span>1'  and <span class="smartquote">`commId` in ( '</span>76832' , <span class="emphasis">'76776'</span> , <span class="emphasis">'77562'</span> , <span class="emphasis">'80363'</span> , <span class="emphasis">'121238'</span> , <span class="emphasis">'182922'</span> , <span class="emphasis">'422947'</span> , <span class="emphasis">'51056'</span> , <span class="emphasis">'185557'</span> , <span class="emphasis">'81276'</span> , <span class="emphasis">'80530'</span> , <span class="emphasis">'80534'</span> , <span class="emphasis">'80217'</span> , <span class="emphasis">'76830'</span> , <span class="emphasis">'184396'</span> , <span class="emphasis">'505857'</span> , <span class="emphasis">'567958'</span> , <span class="emphasis">'78911'</span> , <span class="emphasis">'120264'</span> , <span class="emphasis">'122099'</span> , <span class="emphasis">'80401'</span> , <span class="emphasis">'299956'</span> , <span class="emphasis">'430371'</span> , <span class="emphasis">'308830'</span> , <span class="emphasis">'51235'</span> , <span class="emphasis">'81559'</span> , <span class="emphasis">'116149'</span> , <span class="emphasis">'84449'</span> , <span class="emphasis">'656162'</span> , <span class="emphasis">'502933'</span> , <span class="emphasis">'123895'</span> , <span class="emphasis">'50600'</span> , <span class="emphasis">'80535'</span> , <span class="emphasis">'122851'</span> , <span class="emphasis">'246270'</span> , <span class="emphasis">'299003'</span> , <span class="emphasis">'217889'</span> , <span class="emphasis">'186881'</span> , <span class="emphasis">'286019'</span> , <span class="emphasis">'77388'</span> )   #broker-mobiapi: V1<span class="emphasis">_Find_</span>NearbyCommController@HotComm.php (68) 1423704168;</div><div class="line"><span class="code">    -&gt;</span></div><div class="line"><span class="header">    -&gt; ;</span></div><div class="line">+----+-------------+------------------------------+-------+----------------+-----------+---------+------+------+-----------------------+</div><div class="line"><span class="header">| id | select_type | table                        | type  | possible_keys  | key       | key_len | ref  | rows | Extra                 |</span></div><div class="line">+----+-------------+------------------------------+-------+----------------+-----------+---------+------+------+-----------------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | ajk_market_analysis_20150212 | range | idx1,c_t_s_i_c | c_t_s_i_c | 20      | NULL |  104 | Using index condition |</span></div><div class="line">+----+-------------+------------------------------+-------+----------------+-----------+---------+------+------+-----------------------+</div><div class="line">1 row in set (0.06 sec)</div><div class="line"></div><div class="line"></div><div class="line"><span class="header">dbadmin:ajk_dw_stats&gt; explain SELECT * FROM solly_nh_comm_recomm_lookandlook WHERE `comm_id` IN (228955,252368,228744,249444,237337,237869,236838,236834,250955,211207);</span></div><div class="line">+----+-------------+----------------------------------+-------+---------------+-----------+---------+------+------+-----------------------+</div><div class="line"><span class="header">| id | select_type | table                            | type  | possible_keys | key       | key_len | ref  | rows | Extra                 |</span></div><div class="line">+----+-------------+----------------------------------+-------+---------------+-----------+---------+------+------+-----------------------+</div><div class="line"><span class="header">|  1 | SIMPLE      | solly_nh_comm_recomm_lookandlook | range | NewIndex1     | NewIndex1 | 4       | NULL |  200 | Using index condition |</span></div><div class="line">+----+-------------+----------------------------------+-------+---------------+-----------+---------+------+------+-----------------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/Keithlan/Keithlan.github.io/2015/07/14/mysql_in/" data-id="7wmi76av30k1ymfw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>





  
    <article id="post-mysql_error_1048" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/07/14/mysql_error_1048/" class="article-date">
  <time datetime="2015-07-14T03:32:24.000Z" itemprop="datePublished">Jul 14 2015</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/MySQL/">MySQL</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/07/14/mysql_error_1048/">Mysql Error 1048 奇遇记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前提">前提</h2>
<hr>
<p>上周遇到次奇葩的同步错误，error 1048 ， 看似是简单的not null导致，但是为什么master可以执行，slave不行呢？为什么5.1的slave可以，5.6的slave不行呢？ 带着很多疑问，准备来一窥究竟
        
          <p class="article-more-link">
            <a href="/2015/07/14/mysql_error_1048/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/Keithlan/Keithlan.github.io/2015/07/14/mysql_error_1048/" data-id="wedy7mo64m00itqw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySQL-Error/">MySQL Error</a></li></ul>

    </footer>
  </div>
  
</article>





  
  
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL-Error/">MySQL Error</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/MySQL-Error/" style="font-size: NaNpx;">MySQL Error</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2015/07/14/mysql_shutdown_err/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/07/14/mysql_group_order_limit/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/07/14/mysql_error_1293/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/07/14/mysql_ulimit/">(no title)</a>
          </li>
        
          <li>
            <a href="/2015/07/14/mysql_replicate_rule/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2015 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<script src="/js/script.js" type="text/javascript"></script>


  </div>
</body>
</html>